# ya make: основной сборочный инструмент

Система сборки `ya make` –  основная команда утилиты  `ya`, обеспечивающее автоматизацию сборки проекта, которая позволяет  компилировать код, управлять зависимостями, запускать тесты и генерировать исполняемые файлы в едином и согласованном окружении независимо от сложности проекта.

Чтобы подробно обсудить структуру и процесс работы нашей системы сборки, важно сначала познакомиться с рядом специфических терминов и концепций, которые мы будем использовать. Это поможет лучше понять, как функционирует система и какие преимущества она предоставляет.

Давайте начнем с основных терминов:
1. Сборочная цель (модуль): Программа, библиотека или пакет, которые будут собираться. Она может быть интерпретирована как конкретный результат сборки (артефакт) или как описание сборки, заданное в файле `ya.make`.
2. Артефакт - реальный результат сборки, такой как файл программы или библиотеки, либо директория с файлами пакета.
3. Описание сборки: Файл`ya.make`, который содержит инструкции по сборке программы, библиотеки или пакета.
4. Символьная ссылка: Специальный тип файла, который ссылается на другой файл или директорию.
5. Мультимодули: Специальные сборочные цели, которые могут создавать разные артефакты в зависимости от контекста их использования.
6. Промежуточный модуль: Библиотека или иной компонент, используемый для сборки финальных модулей. Промежуточные модули не предназначены для самостоятельного использования.
7. Финальный модуль: Программа, динамическая библиотека, тест или другой артефакт, который может исполняться и использоваться самостоятельно.
8. UID (Unique Identifier): Уникальный идентификатор для каждой сборочной команды, основанный на всех факторах, влияющих на её результат.
9. Герметичность сборки: Принцип, согласно которому сборка зависит только от данных, известных системе сборки, и не зависит от внешних факторов или файлов, не фиксированных в конфигурации сборки.
10. Конфигурирование: Процесс анализа зависимостей и построения графа сборочных команд в системе `ya make`.
11. Граф сборочных команд: Структура данных, представляющая зависимости между сборочными командами. В узлах графа расположены команды, а ребра указывают на порядок выполнения команд.
12. Макрос: Инструкция в `ya.make`, которая описывает конкретные аспекты сборки, такие как исходный код, зависимости, а также управляет логикой интерпретации файла.
13. PEERDIR: Макрос, указывающий на межмодульную зависимость; говорит системе сборки, что для сборки текущей цели необходима другая сборочная цель.
14. RECURSE/RECURSE_FOR_TESTS: Макросы, используемые для того, чтобы включить одно или несколько сборочных целей в текущий сборочный процесс.

Со всеми базовыми определениями и принципами системы сборки можно ознакомится в соответствующем разделе [документации](https://github.com/mtv2000/yatool/blob/newstyle/docs/ya_make_principle.md)

`ya make` позволяет очень гибко настраивать параметры сборки. Список настраиваемых возможностей включает:

- [Выбор типа и вида сборки](https://github.com/mtv2000/yatool/blob/newstyle/docs/ya_make_buildtype.md) — debug/release, LTO, sanitizers и т. п.
- Параметры платформ — целевые аппаратная платформа и OS, настройки сборочной платформы и т. п.
- Установку сборочных переменных — Например, `-DCFLAGS=-Wall`, `-DDEBUGINFO_LINES_ONLY` и т. п.
- Настройки сборки - выбор дополнительных результатов сборки и т. п.
- Запуск и работу с тестами

## Синтаксис

Ознакомтесь с возможностями сборки: `ya make  -h, --help`  печатает справку . Используйте `-hh` для большего количества опций и `-hhh` для ещё большего.

Со встроенной справкой можно также ознакомиться по [ссылке](helpfilemake.md)

### Общая форма команды

`ya make [OPTIONS]… [TARGET]…`

`[OPTIONS]` обозначает одну или несколько опций команды, предназначенных для изменения поведения сборки или тестирования. Опции могут управлять такими параметрами, как тип сборки (например, отладочный или релиз), применение оптимизации, использование инструментов анализа кода и многое другое.

`[TARGET]…` указывает на одну или несколько целей сборки. Целью может быть конкретный модуль в проекте, директория, содержащая компоненты для сборки, или специально заданный аргумент, определяющий действие (например, запуск тестов). Если цель не указана, ya make обычно выполняет сборку всего проекта, начиная с текущего каталога.

## Опции

Для систематизации многообразия опций, сделать информацию о них более доступной для пользователей опции можно разбить на следующие основные категории:

1.	Основные опции
2.	Опции сборки
3.	Опции Java - сборки
4.	Опции оптимизации
5.	Опции тестирования
6.	Опции вывода и логирования
7.	Опции кеширования
8.	Интеграция с внешними ресурсами
9.	Фаззинг
10.	Опции авторизации

Также опции разделяют по типам:

1.	Основные
2.	Расширенные 
3.	Экспертные

Полный список основных опций и примеры их использования можно найти в этой [документации](https://github.com/mtv2000/yatool/blob/newstyle/docs/ya_make_options.md)
Система сборки предлагает широкие возможности для тестирования, полный перечень опций и их описание можно найти [здесь](https://github.com/mtv2000/yatool/blob/newstyle/docs/ya_make_test.md)


## Платформы 

При сборке кода под платформой понимают аппаратную платформу (CPU, набор машинных инструкций, которые должны быть использованы в бинарном коде), операционную систему, на который должна работать программа, и программные средства, которые должны быть использованы для сборки (компилятор и т. п.). Система сборки ya make не исключение. Платформа для неё — это тройка <компилятор, OS, архитектура>, например <clang11, Windows, x86_64> или <clang10, Android, armv8a>.

По умолчанию в качестве целевой и сборочной платформ выбирается та, где запущена сборка. Т. е. в качестве операционной системы будет выбрана та, где вы работаете (Linux, Darwin (macOS) или Windows), в качестве архитектуры x86_64 или arm64 (для маков на процессоре m1), а в качестве компилятора будет использован вариант по умолчанию (default) для данной OS.

Поменять целевую платформу можно флагом `--target-platform`. В качестве значения нужно указать тройку <компилятор, OS, архитектура>, соединив значения через дефис. Также можно указать какое-то подмножество компонент этой тройки (остальные элементы подставятся по умолчанию). Для выбора компилятора по умолчанию можно указать специальное значение DEFAULT.

Примеры:

`--target-platform clang-win-x86_64` — собрать по Intel 64bit Windows компилятором Clang;
`--target-platform default-android-armv8a` — собрать под Android на ARM (в версии armv8a) компилятором по умолчанию;
`--target-platform windows` — собрать под Windows (и архитектуру по умолчанию x86-64) компилятором по умолчанию.

