# Кеширование результатов сборки

Команда [ya gc cache](gc.md)

## Результаты сборки 

Результаты выполнения сборки можно направить для долговременного сохранения в указанное местоположение с использованием параметра -o/–output . При этом, система автоматически не отслеживает содержимое данной директории , требуя ручного управления и очистки.

В операционных системах Linux и MacOS, без задания параметра --no-src-links, сгенерированные данные будут перенесены в специально выделенное для этого промежуточное хранилище или кэш результатов. В данном случае, доступ к файлам и папкам из этого кэша осуществляется через символические ссылки, размещенные в рабочей директории репозитория.

Удаление файлов из кэша результатов выполняется автоматически по истечении установленного срока действия, стандартно равного одной неделе. Время жизни файлов в кэшее можно скорректировать через параметр symlinks_ttl.

## Вспомогательные файлы сборки

Вспомогательные файлы сборки включают компиляторы, SDK, эмуляторы и другие инструменты, которые не строятся сами, но необходимы для выполнения команд ya, таких как построение и запуск тестов. Эти файлы хранятся в кэше инструментов.

По умолчанию автоматическое удаление этих файлов настроено для Linux и MacOS.

Политика удаления файлов основана на принципе LRU (наименее недавно использованных), с ограничением по объему потребляемого дискового пространства. Значение ограничения по умолчанию можно изменить с помощью параметра `tools_cache_size`.

Важно отметить, что инструменты удаляются только после завершения всех процессов, использующих компилятор, эмулятор и т.д., поэтому мгновенное потребление дискового пространства может превышать установленное ограничение.

Если инструменты запускаются по прямым путям, например, с помощью команды `ya tool cc --print-path`, такие инструменты не подлежат автоматической очистке, так как не контролируются системой. Они будут удалены автоматически в рамках обычной процедуры очистки после запуска команды `ya gc cache`.

## Временные файлы сборки

Временные файлы сборки можно разделить на три категории:

1. Файлы, созданные временными функциями: Эти файлы создаются с использованием функций, таких как mktemp/mkdtemp, и располагаются в временной директории, которая полностью удаляется по завершении работы `ya`.
2. Кешируемые временные файлы: Сюда относятся промежуточные файлы построения, явно указанные через файлы bob.make. Объем дискового пространства для этих файлов можно ограничить параметром `cache_size`, а удаление файлов происходит по политике LRU. К этой категории относятся также файлы, загруженные из распределенного кэша.
3. Временные файлы текущей сборки: Эти файлы преимущественно являются ссылками на файлы из предыдущей категории, но выделены отдельно по нескольким причинам. Во-первых, некоторые промежуточные файлы запрещено использовать в других сборках. Во-вторых, режим сборки с ключом `--rebuild` использует только файлы текущей сборки. В-третьих, ограничение по размеру кэша может быть недостаточным для текущей сборки. Такие файлы обычно удаляются либо во время текущей, либо во время следующей сборки.

Предварительное ограничение дискового пространства для файлов из первой и третьей категорий невозможно. Файлы из второй категории хранятся в локальном кэше сборки

## Конфигурации

Основные параметры для автоматической очистки файлов включают:

1. `cache_size`: Устанавливает предел для размера локального кэша.
2. `tools_cache_size`: Задает ограничение на размер кэша для инструментов.
3. `symlinks_ttl`: Определяет срок хранения результатов сборки, которые кэшируются с помощью `ya`, начиная с момента создания.

Чтобы отключить автоматическое удаление, можно установить большие значения для этих параметров. Удаление директорий построения можно отключить с помощью опции `--keep-temps`.

Пример настроек в `ya.conf`
```
tools_cache_size = "6GiB"
symlinks_ttl = "1h"
cache_size = "80GiB"
```
Без кавычек можно задавать размер в байтах или время в секундах, например, `symlinks_ttl = 3600`

## Ручная очистка

Помимо автоматической очистки кэшей, вы можете вручную освободить дисковое пространство с помощью команды `ya gc cache` Во время выполнения команды также проводятся дополнительные проверки на ошибки.

Команда полностью удаляет:
  - Все вспомогательные файлы, за исключением тех, которые очищаются автоматически.
  - Все временные файлы, кроме локального кэша.

Удаление файлов из локального кэша сборки происходит по следующим фильтрам:
  - `–object-size-limit=OBJECT_SIZE_LIMIT`: Удаляет из кэша крупные объекты (размер указывается в MiB, если не указано иначе).
  - `–age-limit=AGE_LIMIT`: Удаляет из кэша старые объекты (время указывается в часах, если не указано иначе).

Если фильтр не задан, очистка выполняется в соответствии с параметром `cache_size`.

Вы также можете очистить репозиторий от сборочных символических ссылок с помощью команды `ya gc cache --gc-symlinks`.

## Параллельные запуски сборок 

При настройке сред для параллельной сборки важно учитывать риски “отравления” кэшей из-за конкурентного доступа. Обеспечьте синхронизацию доступа к репозиториям и кэшам или принудительно используйте опцию --rebuild в случае возникновения конфликтов.

Конфликты при обращении к временным и вспомогательным файлам обрабатываются `ya make` самостоятельно.

## Статистики, анализ локальной сборки

Запуск `ya make` с опцией `--stat` выдает статистику построения, позволяя оценить использование кэша, производительность сборки и другие важные метрики. Включение `print_statistics = true` в файл конфигурации применяет эту опцию ко всем сборкам проекта.

Пояснение будет дано на примере
```
Info: Node count in the dependency graph is 120340.
Info: Dependency count in the graph is 175273.
Cache hit ratio is 98.79% (85973 of 87024)
# Из графа построения были исполнены только 87024 - 85973 = 1051 узлов. Результаты остальных узлов пришли из локального кэша или распределенного кэша.
# 85973 меньше 120340, так как в число 120340 входят индивидуальные скачивания тулов, задачи записи в кэш и т.п. См. prepare ниже, а так же статистики для кэшей.

```

```
Disk usage for tools/sdk 2.18 GiB
# В кэше инструментов было использованы около 2.18 GiB дискового пространства.
# Значение зависит от того, сколько команд было исполнено, например, если в кэшах были все нужные построения, то компилятор не попадёт в эту статистику.
Additional disk space consumed for build cache 20.29 GiB
# В локальный кэш сборки были дополнительно положены файлы, общий размер которых 20.29 GiB. Учитываются локально исполненные команды и данные из распределенного кэша, продублированные локально.
```

```
Critical path:
[4779 ms] [CC] [eoYv2szE-ix4fS2BbKYhTg]: $(SOURCE_ROOT)/contrib/restricted/boost/libs/python/src/object/inheritance.cpp [started: 0 (1594179882553), finished: 4779 (1594179887332)]
[ 107 ms] [AR] [c1NkJ25BNAn20mFd7FO2hQ]: $(BUILD_ROOT)/contrib/restricted/boost/libs/python/libboost-libs-python.a{, .mf} [started: 4800 (1594179887353), finished: 4907 (1594179887460)]
[5851 ms] [LD] [IDUy5TtSrxw_Ek14XJY6Jw]: $(BUILD_ROOT)/sandbox/tasks/tasks{, .mf} [started: 28452 (1594179911005), finished: 34303 (1594179916856)]
# Критический путь в графе построения (из 87024 - 85973 узлов).
# Чтение из кэшей не учитываются в этом графе.
```

```
Time from start: 336187 ms, time elapsed by graph 10737 ms, time diff 325450 ms.
# Сравнение реального времени исполнения с оценкой времени исполнения исходя из критического пути.
# Разница складывается из-за задержек в очереди на исполнение (недостаток свободных потоков), задержек доставки файлов из кэшей и других накладных расходов
```

```
The longest 10 tasks:
[9422450 ms] [prepare:$(yt-store-get)] local [count: 16164, cps: 1.72, ave time 582.93 msec, failures 210]
# Статистика скачиваний из yt-кэша и последующей распаковки. Скачали 2571 результатов узлов из тех 7936, которые не были перестроены.
# Скачивание параллельное, а 1104 сек характеризует последовательное скачивание, поэтому нужно делать поправку на количество потоков сборки.
# cps (calls-per-seccond) тоже не учитывает параллельное исполнение (в идеальном параллельном исполнении число надо умножать на число потоков --yt-store-threads).
[  84795 ms] [prepare:$(AC-put)] local [count: 17005, cps: 200.54, ave time 4.99 msec]
# Статистика записи в локальный кэш. Запись идет не более, чем в 2 потока.
[  60023 ms] [prepare:FromDistCache(aVv9FCkkaMHM4U6FMXEb8g$(BUILD_ROOT)/sandbox/projects/media/kp-front-nginx/177ad19c87bfc27c45d0778ae3.cpp.o)] local [started: 1594179698517, finished: 1594179758540]
# Индивидуальное скачивание из yt-кэша.
...
```
