## Ограничения, проверяемые системой сборки

В контексте сборки проекта не все зависимости являются разрешенными. Некоторые из них контролируются специальными правилами:
- Часть общих библиотек не рекомендуется к использованию. Новые зависимости на такие библиотеки запрещены.
- Некоторые директории, такие как `internal`, считаются деталями реализации и могут использоваться только в определенных контекстах.
- Некоторые модули не совместимы по зависимостям. Например, модули на `Python 2` и `Python 3` не могут иметь зависимостей друг от друга.

### Правила Peerdir Policy

Файл управляет правилами использования директивы `PEERDIR`, которая определяет зависимости между модулями. В случае нарушения правил система сборки выдаёт ошибки, что помогает избежать нежелательных зависимостей и проблем в процессе сборки.

Для упрощения отслеживания все ограничения хранятся централизованно в директории `build/rules`. При попытке сделать запрещённый `PEERDIR`, система сборки выдаст `configure-ошибку`:
```
PEERDIR from $S/alice/gamma/sdk/golang to $S/vendor/github.com/sirupsen/logrus is prohibited, ignored`
```
Актуальный список правил задаётся переменной `PEERDIRS_RULES_PATH` в `ymake.core.conf`.

Формат правил:
```
[ALLOW|DENY] <regexp_from> -> <regexp_to>
```
С полнострочными комментариями начинающиеся с `#`.

Правила интерпретируются так:
- Если `ALLOW` или `DENY` не задано, считается `DENY`.
- `<regexp_from>` и `<regexp_to>` — это регулярные выражения в формате `PCRE` без пробелов, пробел является разделителем.
- Регулярные выражения применяются к директориям и по умолчанию задают префикс (если не начинаются с `.*`, то подразумевается `^` в начале).
- `<regexp_from>` проверяет директорию, в которой написан `ya.make` c `PEERDIR`, `<regexp_to>` проверяет аргумент `PEERDIR`.
- Если правило `DENY`, то `PEERDIR` запрещён, если `ALLOW`, то разрешён.
- Поиск идёт до первого совпадения обоих `regexp'ов` сверху вниз (правила в начале файла имеют более высокий приоритет). Между файлами приоритет определяется порядком наполнения переменной `PEERDIRS_RULES_PATH`.
- Если ничего не подошло - `PEERDIR` разрешён.

**Примеры:**
```
# Из vendor разрешены любые PEERDIRы
ALLOW vendor/ -> .*
```
```
# Разрешён PEERDIR на Google RPC
ALLOW .* -> vendor/google.golang.org/grpc
# Разрешён PEERDIR на Job Scheduling Package
ALLOW .* -> vendor/github.com/jasonlvhit/gocron
# Все остальные PEERDIRы в vendor запрещены
DENY .* -> vendor/
```
### Глобальная фиксация версий библиотек

Для обеспечения стабильности и совместимости версий библиотек в проектах на Java, в файле конфигурации фиксируются конкретные версии зависимостей. Это помогает избежать конфликтов версий и гарантирует однозначность используемых библиотек.

Глобальная жесткая фиксация версий библиотек производится в глобальной переменной `_FORCED_DEPENDENCY_MANAGEMENT_VALUE`, эту фиксацию версий нельзя обойти с помощью макроса `DEPENDENCY_MANAGEMENT`.

Объявление глобальной фиксации версий библиотек в ymake.core.conf производится в формате:
```make
_FORCED_DEPENDENCY_MANAGEMENT_VALUE= \
    path/to/lib1/1.1 \
    path/to/lib2/2.5 \
    ...
```
При этом использование библиотек в ya.make выглядит так:
```make
PEERDIR(
    path/to/lib1
    path/to/lib2
    ...
)
```
При сборке автоматически будут подставлены `path/to/lib1/1.1` и `path/to/lib2/2.5` вместо указанных `path/to/lib1` и `path/to/lib2`.

Исключения из глобальной жесткой фиксации версий библиотек задаются в глобальной переменной `_FORCED_DEPENDENCY_MANAGEMENT_EXCEPTIONS`. В ней указываются библиотеки (без версии) и проекты, которые могут использовать любые версии этих библиотек.

Этот механизм позволяет точечно исключить определенные проекты из глобальной фиксации версий, установленной в переменной `_FORCED_DEPENDENCY_MANAGEMENT_VALUE`.

В таких проектах глобальная фиксация версий для указанных библиотек будет проигнорирована, однако локальная фиксация через `DEPENDENCY_MANAGEMENT` продолжит работать как обычно.

Объявление исключений указывается в формате `FOR library project1 ...`:
```
_FORCED_DEPENDENCY_MANAGEMENT_EXCEPTIONS= \
    FOR path/to/lib1 \
        path/to/project1 \
        path/to/project2 \
    FOR path/to/lib2 \
        path/to/project1 \
        path/to/project3 \
```
Для указанного объявления проект `project1` может использовать любые версии библиотек `lib1` и `lib2`, проект `project2` может использовать любую версию `lib1`, а проект `project3` любую версию `lib2`.




