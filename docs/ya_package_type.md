## Форматы пакетирования

`ya package` поддерживает пакетирование в различных форматах.

### Доступные форматы пакетов
* [Упакованный tar-архив (.tar.gz)](#Сборка-tar-пакетов) (по умолчанию)
* [Debian-пакет (.deb)](#Сборка-deb-пакетов)
* [rpm-пакет (.rpm)](#Сборка-rpm-пакетов)
* [docker-образ](#Сборка-docker-образов)
* [Python wheel-пакет (.whl)](#Сборка-wheel-пакетов)
* [Нативный мультиплатформенный пакет для Android (.aar)](#Сборка-aar-пакетов)
* [npm-пакет для Node.js](#Сборка-npm-пакетов)

Если у вас есть доступ к универсальному менеджеру репозиториев `artifactory`, вы можете использовать его для [загрузки пакетов](#Загрузка-пакетов-в-artifactory).

С форматом описания пакетов можно ознакомится на [специальной странице](ya_package_format.md)
### Сборка tar-пакетов
Архивы в формате `tar` создаются по умолчанию, если не указать конкретный формат, но также можно использовать ключ `--tar` для явного указания.

**Пример**
```
ya package <pkg.json>
```
или
```
ya package <pkg.json> --tar
```

#### Ключи для сборки пакетов

* `--compression-filter=X` — устанавливает фильтр сжатия для `tar`-архива. По умолчанию используется `gzip`. Доступные варианты: `gzip` и `zstd`.
* `--compression-level=X` — задаёт уровень сжатия для выбранного фильтра. Для `gzip` уровень может быть от 0 до 9 (значение по умолчанию: 6), для `zstd` — от 0 до 22 (значение по умолчанию: 3).
* `--no-compression` — создаёт архив без сжатия.
* `--raw-package` — используется совместно с `--tar`, чтобы сохранить пакет без архивирования.
* `--raw-package-path=PATH` — позволяет указать директорию для сохранения пакета без архивирования.

Для ускорения процесса сборки пакетов вы можете попробовать параметры `--compression-filter=zstd --compression-level=1`. В этом случае будет создан архив с расширением `.tar.zst`.

### Сборка deb-пакетов

Сборка debian-пакета производится с помощью команды
```
ya package --debian <package.json>
```

#### Ключи для сборки deb-пакетов
* `--not-sign-debian` — не подписывать пакет. Такой пакет не сможет быть загружен в репозиторий, но подходит для локальной отладки.
* `--debian-distribution` — указывает версию дистрибутива `Debian` при сборке пакета (по умолчанию: `unstable`).
* `--debian-arch` — указывает архитектуру, передаваемую команде `debuild` через ключ `-a`.
* `--arch-all` — синоним для `Architecture: all`.
* `--force-dupload` — принудительная загрузка пакета командой dupload с ключом `--force`.
* `--debian-compression`, `-z` — степень сжатия deb-файла (none, low, medium, high).
* `--debian-compression-type`, `-Z` — тип сжатия deb-файла (`gzip`, `xz`, `bzip2`, `lzma`, `none`).
* `--publish-to` — публикация пакета в репозиторий (фактически вызывает команду `dupload`).
* `--dupload-max-attempts` — количество попыток публикации пакета с помощью команды `dupload` (по умолчанию: 1).
* `--dupload-no-mail` — использовать команду `dupload` с ключом `--no-mail`.
* `--ensure-package-published` — дожидаться завершения публикации пакета в репозитории.

#### Работа с конфигурационными файлами

В `ya package` по умолчанию включен скрипт `dh_noconffiles`, который определяет, что никакие файлы не считаются конфигурационными, включая файлы из папки `/etc`. Чтобы отменить это поведение, необходимо установить `"noconffiles_all": false` в секции meta.

Если необходимо вызвать дополнительные скрипты или хелперы, требующиеся для настройки сборочного процесса, можно использовать файл `debian/extra_rules`.

#### postinst, prerm, etc
В случае, если требуются `postinst` и другие стандартные `debian`-файлы, необходимо создать каталог `debian` рядом с `json`-описанием пакета и поместить в него нужные файлы, например, `postinst`. Важно: в файлах`postinst`, `prerm` и иных должна присутствовать строка `#DEBHELPER#`.

#### Сборка deb-пакетов для Python
При наличии в пакете путей, в которые устанавливаются пакеты для `Python`, например, `/usr/lib/python2.7/dist-packages`, автоматически срабатывает `debian`-хелпер `dh_pysupport`, который включен по умолчанию. Этот хелпер перемещает все файлы из этих путей в «правильные», по его мнению, места, а именно в `usr/share/pyshared`. В связи с этим важно учитывать следующие моменты:

1. Смена владельцев и изменение прав на файлы не будет работать, так как это действие происходит после вызова хелпера, и исходных путей уже не существует.
2. Необходимо добавить в файл-описание пакета в секцию `meta` зависимость от пакета `python-suppor`t в список `pre-depends`, иначе на чистой машине пакет не подключится к `Python`, даже если файлы присутствуют.

Чтобы отключить `dh_pysupport`, рядом с файлом описания пакета нужно создать файл `debian/extra_rules` с таким содержимым:
```
# Отключение dh_pysupport
override_dh_pysupport:
```
Если ваша сборка пакета явно обуславливается использованием `dh_pysupport`, добавьте в секцию `build-depends` пакет `python-support`, например:
```
 "meta": {
        ...
        "build-depends": ["python-support"]
    },
```

#### Известные проблемы
* `debian/rules:X: *** missing separator.  Stop.
dpkg-buildpackage: error: fakeroot debian/rules clean subprocess returned exit status 2`
Одна из частых причин этой ошибки — использование пробелов вместо табуляции (`\t`) для отступов в описании правил в `debian/extra_rules`.

* Пакет `ya package` использует системные инструменты для сборки deb-пакетов, поэтому результат зависит от используемой операционной системы и может быть несовместим с другой. Обратите внимание на следующие моменты:
    - Алгоритм компрессии (`xz`), выбираемый `dpkg-builddeb` по умолчанию в новых версиях `Ubuntu`, несовместим с `precise`.
    - На дистрибутивах до `Ubuntu xenial` не удастся правильно собрать пакет с поддержкой `systemd`.

### Сборка rpm-пакетов
Чтобы собрать `rpm`-пакет, выполните команду:
```
ya package --rpm <pkg.json>
```

При сборке пакета поля из секции `meta` описания пакета формируют файл `.spec`. Если вам нужны дополнительные секции, такие как `post` и другие, создайте каталог `rpm` и поместите в него файлы с именами, соответствующими названиям секций и нужным содержимым (поддерживаются `pre`, `post`, `preun`, `postun`, `check`, `changelog`).

Для локальной сборки `rpm`-пакетов на машине должна быть установлена утилита `rpmbuild`.

Если `rpm` не является основным пакетным менеджером в вашей системе, мы не рекомендуем собирать `rpm`-пакеты локально.

### Сборка docker-образов
С помощью команды:
```
ya package <package.json> --docker
```
можно собрать `Docker`-образ. Для этого в `JSON`-описание пакета нужно добавить `Dockerfile`, который будет использоваться для последующих вызовов `docker build` и `docker push`. Сам файл не обязательно должен находиться рядом с `JSON`-описанием, но обязательно должен иметь `/Dockerfile` в `destination`, например:
```
{
    "source": {
        "type": "RELATIVE",
        "path": "Dockerfile"
    },
    "destination": {
        "path": "/Dockerfile"
    }
}
```
Перед вызовом команды `docker build` в рабочей директории производится сборка пакета и подготовка его содержимого. Таким образом, при формировании команд в `Dockerfile` (например, `COPY`) можно рассчитывать на наличие файлов и структуру каталогов, описанных в `JSON`-описании.

#### Внимание

* По умолчанию пакет будет иметь тег вида `registry.YOURREPO.net/<repository>/<package name>:<package version>`.
    - `registry.YOURREPO.net` — реестр образов, задается через параметр `--docker-registry`.
    - `<repository>` — название репозитория для пакета, задается через `--docker-repository` и по умолчанию не имеет значения.
* Для успешной работы `ya package --docker` необходимо наличие установленного на хост-платформе `Docker` и права на его запуск.
* `ya package --docker` не выполняет действий по авторизации в реестре (команда `docker login`) — предполагается, что пользователь заранее об этом позаботился.
* Если не задан параметр `--docker-save-image`, то в архиве пакета будет только результат работы команд `docker`.
* Бинарные файлы, собираемые в процессе работы `ya package --docker`, по умолчанию будут собраны под вашу хост-платформу, а не под платформу, указанную в `Docker`. Чтобы изменить платформу, нужно явно указать ее в поле `target-platforms` секции `build`. 

#### Ключи для сборки Docker-образов
- `--docker-platform` — указание платформы, под которой будет работать образ. Опция полезна, если платформа, на которой собирается пакет, отличается от платформы, на которой будет работать образ. Может быть указана в секции `params`.
- `--docker-registry` — указание реестра для публикации.
- `--docker-repository` — указание репозитория для образа (участвует в имени образа).
- `--docker-save-image` — сохранение образа в виде отдельного файла в архиве.
- `--docker-push` — происходит публикация образа в реестре.
- `--docker-no-cache` — указание ключа `--no-cache` для выполняемой в фоне команды `docker build`.
- `--docker-use-remote-cache` — указание ключа `--cache-from` для выполняемой в фоне команды `docker build`.
- `--docker-network` — указание ключа `--network` для выполняемой в фоне команды `docker build`.
- `--docker-build-arg` — указание ключа --build-arg для выполняемой в фоне команды `docker build`, формат значения должен быть `<key>=<value>`.
- `--docker-secret` — указание ключа --secret для выполняемой в фоне команды `docker build`, формат значения должен иметь вид `id=ENV_VAR` (см. [документацию](https://docs.docker.com/build/building/secrets/#sources)).
- `--custom-version` — указание специфичного тега образа (по умолчанию тег берётся из имени текущей ветки).

При передаче аргументов в контейнер не забудьте добавить в `Dockerfile` соответствующую директиву:
```
ARG MY_ARG_NAME
```

#### Использование удаленного кэша
При добавлении `--docker-use-remote-cache` в качестве источника кэша используется образ из реестра, путь до которого формируется на основе данных из `package.json`. Дополнительно можно указать `--docker-remote-image-version`, и тогда в качестве источника будет использоваться образ указанной версии.

В качестве кэша могут использоваться только те образы, которые были собраны с флагом `BUILDKIT_INLINE_CACHE=1`. Собрать образ с этим флагом можно, например, так:
```
ya package package.json --docker --docker-build-arg BUILDKIT_INLINE_CACHE=1
```
В некоторых случаях Docker может автоматически не включить `BuildKit`, тогда это необходимо сделать отдельно с помощью переменной окружения `DOCKER_BUILDKIT=1`.

#### Передача секрета в контейнер для docker build
В случае необходимости безопасно передать секрет внутри `Docker`-контейнера для его сборки, вы можете воспользоваться опцией --`docker-secret id=ENV_VAR` (без указания значения), где `ENV_VAR` — переменная окружения, которая содержит необходимое значение секрета. Подробнее смотрите документацию о секретах [docker build secrets](https://docs.docker.com/build/building/secrets/#sources).

**Не передавайте секреты через Docker build args, это небезопасно. Для передачи секрета используйте `--docker-secret`.**

### Сборка wheel-пакетов
Чтобы собрать `wheel`-пакет, выполните команду:
```
ya package <package.json> --wheel
```
В `JSON`-конфиге пакета нужно описать структуру пакета, включая специальный скрипт `setup.py` в корне, который формирует пакет и вызывается с параметром `bdist_wheel`. Для сборки пакета для `Python 3`, добавьте опцию `--wheel-python3` следующим образом:
```
ya package <package.json> --wheel --wheel-python3
```
Версию пакета достаточно указать в `package.json`, а в `setup.py` её можно получить через переменную окружения `ya_PACKAGE_VERSION`:
```
setup(
    <...>,
    version=os.environ.get("YA_PACKAGE_VERSION"),
)
```

#### Публикация пакета

Если при вызове `ya package` добавить параметр `--publish-to <repo_addr>`, то после сборки пакет будет опубликован с помощью вызова `twine upload --repository-url <repo_addr>`. Ключи от репозитория будут запрошены в консоли.

### Сборка aar-пакетов

Для сборки aar-пакетов, нужно выполнить команду с ключом `--aar`.
```
ya package --aar <package.json>
```

#### Публикация пакетов
Для публикации `AAR`-пакетов, добавьте к запуску ключ `--publish-to <settings.xml>`. Файл `settings.xml` должен содержать параметры, необходимые для загрузки пакета в `Artifactory`.

При публикации пакета внутри `ya package` выполняется команда: `mvn -s <settings.xml> deploy:deploy-file -Dfile=<путь до собранного aar пакета>`

### Сборка npm-пакетов
Чтобы собрать npm-пакет, выполните команду с ключом `--npm`:
```
ya package <pkg.json> --npm
```
Обратите внимание, что для `npm`-пакетов имя `package.json` уже имеет предопределённое значение, поэтому конфиг для `ya package` нужно назвать по-другому, например, `pkg.json`. В описании пакета `pkg.json` нужно указать структуру пакета с файлом `package.json` в корне, который описывает сам `npm`-пакет.

#### Публикация пакетов

Для публикации необходимо указать целевой `npm registry` через опцию `--publish-to <npm_registry>`, и после сборки пакет будет опубликован. При локальном запуске с целью публикации авторизационная информация берётся из локального `.npmrc`-конфига. Версию собираемого пакета можно переопределить с помощью опции `--custom-version`.

### Загрузка пакетов в artifactory

Для загрузки пакета в `artifactory` необходимо создать и заполнить файл `settings.xml`, который содержит описание опций, нужных для заливки данных.

#### Общая информация

- Используемые инструменты: Для загрузки файлов в `Artifactory` используется плагин `deploy-file` для `Maven`.
- Файл настроек: `settings.xml` — это файл конфигурации, используемый в `Maven Deploy Plugin`.
- Значение: В `settings.xm`l можно задать параметры, которые иначе передавались бы в `Maven` без использования `ya  package`
- Подстановка версий: В `settings.xml` возможна подстановка версии пакета, которая берется из вашего файла `package.json`.

Для выполнения загрузки данных в `Artifactory` выполните следующие шаги:

1. Создание `settings.xml`: Создайте и заполните файл `settings.xml` с необходимыми параметрами.
2. Запуск команды `ya package`: Запустите команду `ya package` с дополнительными параметрами:
  - --artifactory — указывает использование `Artifactory`.
  - --publish-to — указывает путь к файлу `settings.xml`. Путь может быть абсолютным или относительным от корня вашего проекта.
3. Указание файла с паролем: Используйте параметр `--artifactory-password-path` для указания пути к файлу, содержащему пароль к `Artifactory`.
