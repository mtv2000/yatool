## ya test

Команда `ya test` предназначена для тестирования программных проектов.

### Общий синтаксис команды
`ya test  -h, --help` печатает справку . Используйте `-hh` для большего количества опций и `-hhh` для ещё большего.

Команда предлагает широкий спектр опций и параметров, которые позволяют управлять процессом тестирования. С описанием всех функций можно ознакомится по [ссылке](ya_make_test.md)

Общий синтаксис команды `ya test` можно описать следующим образом:

`ya test [OPTION]… [TARGET]…`

* `ya test`:  
Это основной вызов команды, который инициирует запуск тестов.

* [OPTION]...:  
Это параметры и опции, которые уточняют, как должны быть выполнены тесты. Опции позволяют выбрать конкретные тесты для запуска, управлять выводом результатов, включать режимы отладки и прочее. Можно указывать несколько опций через пробел.

* [TARGET]...:  
Это необязательные аргументы, определяющие конкретные цели тестирования, такие как имена тестовых наборов или индивидуальных тестов, которые следует запустить. Можно указать несколько целей через пробел.

### Основные понятия

#### Test

Test (Тест) — это индивидуальная проверка, написанная на поддерживаемом языке программирования. Тесты предназначены для проверки различных аспектов функциональности кода, включая корректность выполнения логики, соответствие стандартам оформления, устойчивость к ошибкам и покрытие тестами.

#### Chunk

Chunk (Чанк) — сущность, обозначающая запуск программы с тестами в виде отдельного узла в графе команд сборки. Чанк включает в себя группу тестов, которые определены в рамках данного запуска, а также может обрабатывать ошибки, возникающие за пределами выполнения тестов.

#### Suite

Suite (Набор тестов) — это коллекция нескольких тестов одного типа, которые имеют схожие зависимости и параметры. Suite используется для группировки и управления тестами с общими характеристиками.

#### Взаимосвязь между понятиями
- Тесты объединяются в Chunk на основе общей логики и последовательности выполнения.
- Chunks группируются в Suite, который предоставляет контексты и параметры для всех входящих в него тестов.
- Suite является основной единицей для запуска и фильтрации тестов, а также отслеживания зависимостей и ошибок.

### Описание тестов

Файл `ya.make` служит для описания тестов. Можно описывать тесты для основных языков программирования, используя соответствующие тестовые фреймворки. Поддержка тестов реализована на основе этих фреймворков для каждого языка.

При составлении файла `ya.make` для создания и управления тестами необходимо структурированно использовать [ключевые макросы и опции](test_yamake.md), чтобы задать все необходимые параметры и зависимости.

В файле `ya.make` необходимо указать зависимости, определить размеры тестов, установить временные ограничения, а также задать теги и требования к ресурсам:

По умолчанию один тестовый модуль является одной `suite`. `suite` аккумулирует в себе ошибки тестирования, которые выходят за пределы определения теста, например:
- ошибки получения списка тестов
- ошибки инициализации тестирования (до фактического выполнения тестов)
- ошибки финализации тестирования

`suite` имеет несколько параметров:
- Указание фрэймворка тестирования
- Список файлов с тестами
- Список зависимостей
- Размер
- Тэги
- Требования к запуску тестов
- Переменные окружения
- Таймаут на запуск
```
DEPENDS(project/lib)                    # Указывает зависимости проекта
SIZE(MEDIUM)                            # Определяет размер теста (SMALL, MEDIUM, LARGE)
TIMEOUT(120s)                           # Устанавливает время выполнения теста
TAG(performance integration)            # Добавляет теги к тестам
REQUIREMENTS(cpu:4 disk_usage:10GB ram:8GB) # Указывает требования к ресурсам
```
Подробнее про описание тестов можно прочитать в [документации](test_yamake.md)

### Запуск тестов

При запуске тестов в локальной среде разработки, необходимоо понимать следующие аспекты локальной работы:

- Конфигурация: Все тесты локально запускаются в конфигурации debug.
- Таймауты: Локальный запуск тестов учитывает таймауты в зависимости от размера теста (SMALL, MEDIUM, LARGE).
- Сохранение результатов: Результаты тестов сохраняются в директорию test-results.

Для простого запуска тестов есть следующие ключи командной строки:

- `-t` — запустить только SMALL тесты.
- `-tt` — запустить SMALL и MEDIUM тесты.
- `-ttt`, `-A`, `--run-all-tests` — запустить тесты всех размеров.
- `--test-param=TEST_PARAM` — параметризовать тесты значениями из командной строки. `TEST _PARAM` имеет вид `name=val`, доступ к параметрам зависит от используемого фреймворка.

**Пример**

```
$ ya test -t devtools/examples/tutorials/python
```

Запустит все тесты, которые найдёт по `RECURSE`/`RECURSE_FOR_TESTS` от `devtools/examples/tutorials/python`, включая тесты стиля и тесты импорта для Python. Использует следующие умолчания для сборки:

- Платформа будет определена по *реальной платформе*, на которой запущена команда `ya test`.
- Тесты будут собраны в режиме `debug` — он используется по умолчанию.
- Кроме тестов будут собраны все остальные цели (библиотеки и программы), достижимые по `RECURSE`/`RECURSE_FOR_TESTS` от `devtools/examples/tutorials/python`. Это включает сборку всех необходимых зависимостей.

По умолчанию система сборки запустит все запрошенные тесты. После запуска тестов для всех упавших тестов будет выдана краткая информация о падениях (включая ссылки на более полную информацию). Для прошедших и проигнорированных (отфильтрованных) тестов будет выдан только общий короткий статус (количество тех и других).

#### Управление выводом результатов

Команда `ya test` предоставляет несколько опций для управления выводом результатов тестирования. Эти опции позволяют контролировать объем информации, которые возвращаются после запуска тестов, и помогают быстрее находить и исправлять ошибки. 

##### Листинг тестов
- `-L`, `--list-tests`:
- Описание: Данная опция выводит список тестов, которые будут выполнены, без их фактического запуска.
- Преимущества: Позволяет быстро проверить, какие тесты включены в план тестирования, и убедиться, что нужные тесты будут выполнены.
- Пример использования: `ya test -tL`

##### Немедленное прекращение выполнения тестов при первой встреченной неудаче
- `--fail-fast`:
- Описание: Эта опция завершает выполнение тестового прогона сразу после первой встреченной неудачи.
- Преимущества: Полезна для экономии времени и ресурсов, особенно когда ищут конкретную ошибку и не хотят дожидаться окончания всех тестов.
- Пример использования: `ya test -t --fail-fast`

##### Показать пройденные тесты
- `-P`, `--show-passed-tests`:
- Описание: Показать каждый пройденный тест.
- Преимущества: Позволяет видеть подробный отчёт о каждом успешном тесте.
- Пример использования: `ya test -t -P`

##### Показать пропущенные (отфильтрованные) тесты
- `--show-skipped-tests`:
- Описание: Показать каждый пропущенный (отфильтрованный) тест.
- Преимущества: Позволяет легко увидеть, какие тесты не запускались и по каким причинам.
- Пример использования: `ya test -t --show-skipped-tests`

##### Показать метрики тестов
- `--show-metrics`:
- Описание: Показать метрики тестов.
- Преимущества: Позволяет выводить метрики тестов.
- Пример использования: `ya test -t --show-metrics`

#### Дополнительные флаги и параметры

##### Отладочный режим
- `--test-debug`:
- Описание: Включает режим отладки тестов. При запуске тестов, выведет идентификатор процесса (PID) после запуска и включает дополнительные параметры такие как `--test-threads=1`, `--test-disable-timeout`, `--retest` и `--test-stderr`.
- Преимущества: Помогает проводить отладку тестов, выявлять причины сбоев и получать больше информации для диагностики проблем.
- Пример использования: `ya test -t --test-debug`

##### Запуск исполняемых тестов с дебаггером
- `--pdb`, `--gdb`, `--dlv`:
- Описание: Запуск тестов с интеграцией в различные отладчики (например, `pdb` для `Python`, `gdb` для `C++` или `dlv` для `Go`).
- Преимущества: Позволяет проводить глубокую отладку тестов в выбранных отладчиках, что помогает в  детальной диагностике и устранении ошибок.
- Пример использования: `ya test -t --gdb`

#### Суммирование вывода результатов

В конце выполнения тестов для всех упавших тестов будет выдана краткая информация о невыполнении (включая ссылки на более полную информацию). Для прошедших и проигнорированных (отфильтрованных) тестов будет выдан только общий короткий статус с количеством тех и других тестов.

Примеры полного отчета при использовании различных опций:
```
ya test -t --show-passed-tests --show-skipped-tests --show-metrics
```
В этом примере выводится информация о всех успешно пройденных тестах, отфильтрованных тестах, а также метрики тестирования, что дает полный обзор выполненных действий и результатов тестирования.

**Пример**
```
# Список всех пользовательских тестов (без тестов стиля, импортов и подобных проверок)
ya test -AL --regular-tests devtools/examples/tutorials/python
```
Команда `ya test` поддерживает [параллельный запуск тестов](test_parallel.md). 
Подробную информацию обо всех базовых макросах для тестов можно найти [здесь](test_yamake.md).

### Проверки кода и корректности данных

В системе сборки доступны различные инструменты для проверки кода и данных, которые обеспечивают соответствие стандартам качества кода, стиля и безопасность. Эти проверки включают линтеры, статический анализ и другие средства для различных языков программирования.

#### Python

##### flake8
`flake8` автоматически проверяет стиль кода для всех python-файлов, подключенных через ya.make в секциях `PY_SRCS` и `TEST_SRCS`. Анализ проводится по флагам, которые включают ряд других плагинов:

1. Длина строки: Устанавливается в 200 символов.
2. Игнорирование ошибок:
- Для конкретных строк можно использовать комментарии # noqa или # noqa: E101.
- В файле `__init__.py` можно подавлять ошибку `F401` с помощью комментария `# flake8 noqa: F401`.

Для директории contrib допускается отключение проверки стиля макросом `NO_LINT()`.

##### black
Для проектов на `Python3` можно подключить линтер `black` с помощью макроса `STYLE_PYTHON()`. Этот макрос будет генерировать тесты, проверяя соответствие кода в модуле стандартам стиля.

Примечание: Макрос `STYLE_PYTHON()` используется только для типов модулей PY3* и PY23*.

Командой `ya test -t  --test-type black` можно запускать только `black` тесты внутри проекта.

##### Импорт-тесты
Проверки импортируемости для `Python` программ `PY2_PROGRAM`, `PY3_PROGRAM`, `PY2TEST`, `PY3TEST`, `PY23_TEST`, собранных из модулей:

- Проверка называется `import_test`.
- Не является `style`-тестами и собирается с помощью `inline`-сборки.
- Обнаруживает конфликты и отсутствующие файлы в `PY_SRCS`.

Отключение проверки стиля: `NO_CHECK_IMPORTS` с указанием списка, например:

```
NO_CHECK_IMPORTS(
    devtools.pylibrary.
)
```
#### Java

##### Java codestyle
Для всех исходных текстов на `Java`, подключенных через `ya.make`, включены проверки стиля кода с помощью утилиты `checkstyle`. Проверка проводится на два уровня:

1. Обычный уровень (default).
2. Строгий уровень: Включается макросом `LINT(strict)`.

Конфигурационные файлы `checkstyle` лежат в директории `resource`.

##### Java classpath clashes
Опциональная проверка на наличие дублирующихся классов в `classpath` при компиляции:

- Файл класса проверяется на сходство по имени и содержимому (хэш-сумма).
- Включается макросом `CHECK_JAVA_DEPS(yes)`.

#### Kotlin

##### ktlint
Автоматически добавляется к проектам на `Kotlin`, использует утилиту `ktlint` для проверки стиля кода.

- Отключение проверки стиля: `NO_LINT(ktlint)` в `ya.make` файле модуля.
- Исключения: создав файл исключений и добавив макрос `KTLINT_BASELINE_FILE`.

#### Go

##### gofmt
`gofmt` автоматически добавляется к проектам на `Go` и проверяет стиль кода.

##### govet
`govet` является статическим анализатором для `Go`, который помогает находить подозрительные конструкции и антипаттерны.

#### C++

##### clang-tidy
`clang-tidy` используется для статического анализа кода C++. Запускается с флагом `ya test -t -DTIDY`.

#### Frontend

##### eslint
`eslint` автоматически добавляется к проектам на `TypeScript` для проверки стиля кода и типичных ошибок.

Отключение проверки стиля: `NO_LINT()` в `ya.make` файле модуля.

### Пример использования макросов
Пример `ya.make` файла с проверками стиля может выглядеть так:
```
OWNER(g:some-group)

PY3_LIBRARY()

PY_SRCS(
    src/init.py
    src/module.py
)

STYLE_PYTHON()

NO_CHECK_IMPORTS(
    devtools.pylibrary.
)

END()
```

#### Специальные режимы запуска и опции
- --style: Запуск только style-тестов (имплицитно включает кэширование).
- --retest: Принудительный перезапуск тестов без использования кэша.

### Выборочное тестирование (фильтрация)

Команда `ya test` поддерживает большое количество опций для фильтрации и выборочного запуска тестов.

#### Фильтрация тестов по имени
- `-F=TESTS_FILTERS`, `--test-filter=TESTS_FILTERS`:
  - Описание: Эта опция позволяет ограничить тестирование только определенными тестами, соответствующими указанным фильтрам. Фильтры могут быть именами тестов, частями имен, или другими идентифицирующими шаблонами.
  - Пример использования: Запуск тестов, имя которых содержит “subname”.
```
    ya test -A -F “subname”
```
  - Символы-шаблоны: В фильтрах можно использовать символы подстановки, такие как `*`, который соответствует любому количеству символов. Каждый последующий фильтр расширяет множество тестов для запуска.
    ```
    $ ya test -t -F <file>.py::<ClassName>::*
    ```
#### Фильтрация тестов по тегам
- `--test-tag=TEST_TAGS_FILTER`:
  - Описание: Позволяет запускать только те тесты, которые помечены определенными тегами. Теги— это пользовательские метки, которые могут быть назначены на тесты для группировки по определенным признакам или функциональности.
  - Синтаксис: Перед именами тегов можно использовать + для включения тега в фильтр и - для исключения.
  - Пример: 
    ```
      ya test -A --test-tag tag1+tag2-tag3
    ```
    Эта команда запустит все тесты, у которых есть теги tag1 и tag2 и нет тега tag3.

#### Фильтрация тестов по размеру
- `--test-size=TEST_SIZE_FILTERS`:
  - Описание: Фильтр для запуска тестов определенного размера (SMALL, MEDIUM, LARGE), позволяющий более точно настроить объем запускаемых тестов в зависимости от текущих потребностей.
  - Пример использования:
```
    ya test -A --test-size=MEDIUM
```
    Эта команда запустит только тесты среднего размера (MEDIUM).

#### Фильтрация тестов по типу
- `--test-type=TEST_TYPE_FILTERS`:
  - Описание: Ограничивает запуск только теми тестами, которые относятся к указанным типам (например, UNITTEST, PYTEST). 
  - Синтаксис: Перед именами типов тестов можно использовать `+` для включения и `-` для исключения.
  - Пример:
    ```
      ya test -tt --test-type unittest+gtest
    ```
    Эта команда запустит только тесты типов unittest и gtest.
    ```
    ya test -tt --test-type -import_test
    ```
    Эта команда запустит все тесты, кроме `import_test`.

#### Фильтрация тестов по имени файлов
- `--test-filename=TEST_FILES_FILTER`:
  - Описание: Эта опция позволяет запускать тесты только из выбранного исходного файла. Работает только для pytest и hermione, другие тестовые фреймворки не предоставляют такой информации.
  - Пример использования:
    ```
    ya test -A --test-filename=test_example.py
    ```
#### Запуск последних упавших тестов
- -X, --last-failed-tests:
  - Описание: Запустить только тесты, упавшие в предыдущем запуске.
  - Преимущества: Эта опция позволяет быстро проверить, были ли исправлены проблемы, обнаруженные в предыдущем прогоне тестов.
  - Пример использования:
    ```
    ya test -t -X
    ```
  - Совместимость с другими фильтрами: Указание дополнительных фильтров (например, с помощью -F) расширяет множество тестов, которые будут запущены. Это может быть полезно, если необходимо следить за корректным статусом некоторых тестов, наряду с перезапуском упавших в предыдущем прогона.

### Канонизация (и переканонизация)

Для некоторых типов тестов в системе сборки поддерживается механизм сравнения с эталонными (каноническими) данными. 

1. Канонические данные: Это эталонные данные, с которыми сравниваются результаты теста.
2. Канонизация: Процесс обновления эталонных данных, чтобы соответствовать текущим результатам тестов.
3. Переканонизация: Повторная канонизация, проводимая для обновления эталонных данных после изменения тестов или их окружения. Если  данные нужно обновить воспользуйтесь опцией `-Z` (`--canonize-tests`).

При локальном запуске, эталонные данные могут сохраниться в подкаталог `canondata` рядом с тестом.

Более подробная информация находится в [документации](test_canonize.md).

### Тесты с Санитайзером

Система позволяет собирать инструментированные программы с санитайзерами. Поддерживаются санитайзеры AddressSanitizer, MemorySanitizer, ThreadSanitizer, UndefinedBehaviorSanitizer и LeakSanitizer.

Запуск с санитайзером:
```
ya test -t --sanitize=address
```
Для правильной работы санитайзеров можно зафиксировать опции для конкретных тестов через макрос ENV()

Более подробная информация находится в [документации](test_sanitaze.md).

### Fuzzing

Фаззинг позволяет передавать приложению на вход неправильные, неожиданные или случайные данные. Автоматический фаззинг поддерживается через libFuzzer.

Пример запуска фаззинга:
```
ya test -r --sanitize=address --sanitize-coverage=trace-div,trace-gep -A --fuzzing
```
Метрики:
- Запись метрик во время фаззинга, таких как размер корпуса, количество проверенных кейсов, пиковое потребление памяти и другие.

Более подробная информация находится в [документации](test_fuzzing.md).

### Запуск произвольных программ (`Exec`-тесты)

`Exec`-тесты позволяют выполнять произвольные команды и проверять их успешное завершение. Успешным считается завершение команды с кодом возврата 0. Полезно для проверки отдельных скриптов, выполнения командной строки или проверки сложных сценариев, которые трудно реализовать через стандартные тестовые фреймворки.

Такие тесты также описываются в файле `ya.make`. Более подробная информация находится в [документации](test_exec.md).


### Типы тестов

**Типом теста** называется выполнение проверок с использованием одного конкретного инструмента, например, фреймворка `pytest` для Python или утилиты проверки форматирования кода `go fmt` для Golang. Полный список типов тестов приведен в [таблице] (ya_make_typetest.md)


