## ya test

Команда `ya tes`t предназначена для тестирования программных проектов.

### Общий синтаксис команды
`ya test  -h, --help` печатает справку . Используйте `-hh` для большего количества опций и `-hhh` для ещё большего.

Команда предлагает широкий спектр опций и параметров, которые позволяют управлять процессом тестирования. С описанием всех функций можно ознакомится по [ссылке](ya_make_test.md)

Общий синтаксис команды `ya test` можно описать следующим образом:

`ya test [OPTION]… [TARGET]…`

* `ya test`:
Это основной вызов команды, который инициирует запуск тестов.

* [OPTION]...:
Это параметры и опции, которые уточняют, как должны быть выполнены тесты. Опции позволяют выбрать конкретные тесты для запуска, управлять выводом результатов, включать режимы отладки и прочее. Можно указывать несколько опций через пробел.

* [TARGET]...:
Это необязательные аргументы, определяющие конкретные цели тестирования, такие как имена тестовых наборов или индивидуальных тестов, которые следует запустить. Можно указать несколько целей через пробел.

### Основные понятия

#### Test

Test (Тест) — это индивидуальная проверка, написанная на поддерживаемом языке программирования. Тесты предназначены для проверки различных аспектов функциональности кода, включая корректность выполнения логики, соответствие стандартам оформления, устойчивость к ошибкам и покрытие тестами.

#### Chunk

Chunk (Чанк) — сущность, обозначающая запуск программы с тестами в виде отдельного узла в графе команд сборки. Чанк включает в себя группу тестов, которые определены в рамках данного запуска, а также может обрабатывать ошибки, возникающие за пределами выполнения тестов.

#### Suite

Suite (Набор тестов) — это коллекция нескольких тестов одного типа, которые имеют схожие зависимости и параметры. Suite используется для группировки и управления тестами с общими характеристиками.

#### Взаимосвязь между понятиями
- Тесты объединяются в Chunk на основе общей логики и последовательности выполнения.
- Chunks группируются в Suite, который предоставляет контексты и параметры для всех входящих в него тестов.
- Suite является основной единицей для запуска и фильтрации тестов, а также отслеживания зависимостей и ошибок.

### Описание тестов

Файл `ya.make` служит для описания тестов. Можно описывать тесты для основных языков программирования, используя соответствующие тестовые фреймворки. Поддержка тестов реализована на основе этих фреймворков для каждого языка.

При составлении файла `ya.make` для создания и управления тестами необходимо структурированно использовать [ключевые макросы и опции](), чтобы задать все необходимые параметры и зависимости.

В файле `ya.make` необходимо указать зависимости, определить размеры тестов, установить временные ограничения, а также задать теги и требования к ресурсам:

По умолчанию один тестовый модуль является одной `suite`. `suite` аккумулирует в себе ошибки тестирования, которые выходят за пределы определения теста, например:
- ошибки получения списка тестов
- ошибки инициализации тестирования (до фактического выполнения тестов)
- ошибки финализации тестирования

`suite` имеет несколько параметров:
- Указание фрэймворка тестирования
- Список файлов с тестами
- Список зависимостей
- Размер
- Тэги
- Требования к запуску тестов
- Переменные окружения
- Таймаут на запуск
```
DEPENDS(project/lib)                    # Указывает зависимости проекта
SIZE(MEDIUM)                            # Определяет размер теста (SMALL, MEDIUM, LARGE)
TIMEOUT(120s)                           # Устанавливает время выполнения теста
TAG(performance integration)            # Добавляет теги к тестам
REQUIREMENTS(cpu:4 disk_usage:10GB ram:8GB) # Указывает требования к ресурсам
```
Подробнее про описание тестов можно прочитать в [документации]()

### Запуск тестов

При запуске тестов в локальной среде разработки, необходимоо понимать следующие аспекты локальной работы:

- Конфигурация: Все тесты локально запускаются в конфигурации debug.
- Таймауты: Локальный запуск тестов учитывает таймауты в зависимости от размера теста (SMALL, MEDIUM, LARGE).
- Сохранение результатов: Результаты тестов сохраняются в директорию test-results.

Для простого запуска тестов есть следующие ключи командной строки:

- `-t` — запустить только SMALL тесты.
- `-tt` — запустить SMALL и MEDIUM тесты.
- `-ttt`, `-A`, `--run-all-tests` — запустить тесты всех размеров.
- `--test-param=TEST_PARAM` — параметризовать тесты значениями из командной строки. `TEST _PARAM` имеет вид `name=val`, доступ к параметрам зависит от используемого фреймворка.

**Пример**

```
$ ya test -t devtools/examples/tutorials/python
```

Запустит все тесты, которые найдёт по `RECURSE`/`RECURSE_FOR_TESTS` от `devtools/examples/tutorials/python`, включая тесты стиля и тесты импорта для Python. Использует следующие умолчания для сборки:

- Платформа будет определена по *реальной платформе*, на которой запущена команда `ya test`.
- Тесты будут собраны в режиме `debug` — он используется по умолчанию.
- Кроме тестов будут собраны все остальные цели (библиотеки и программы), достижимые по `RECURSE`/`RECURSE_FOR_TESTS` от `devtools/examples/tutorials/python`. Это включает сборку всех необходимых зависимостей.

По умолчанию система сборки запустит все запрошенные тесты. После запуска тестов для всех упавших тестов будет выдана краткая информация о падениях (включая ссылки на более полную информацию). Для прошедших и проигнорированных (отфильтрованных) тестов будет выдан только общий короткий статус (количество тех и других).

#### Управление выводом результатов

Команда `ya test` предоставляет несколько опций для управления выводом результатов тестирования. Эти опции позволяют контролировать объем информации, которые возвращаются после запуска тестов, и помогают быстрее находить и исправлять ошибки. 

##### Листинг тестов
- `-L`, `--list-tests`:
- Описание: Данная опция выводит список тестов, которые будут выполнены, без их фактического запуска.
- Преимущества: Позволяет быстро проверить, какие тесты включены в план тестирования, и убедиться, что нужные тесты будут выполнены.
- Пример использования: `ya test -tL`

##### Немедленное прекращение выполнения тестов при первой встреченной неудаче
- `--fail-fast`:
- Описание: Эта опция завершает выполнение тестового прогона сразу после первой встреченной неудачи.
- Преимущества: Полезна для экономии времени и ресурсов, особенно когда ищут конкретную ошибку и не хотят дожидаться окончания всех тестов.
- Пример использования: `ya test -t --fail-fast`

##### Показать пройденные тесты
- `-P`, `--show-passed-tests`:
- Описание: Показать каждый пройденный тест.
- Преимущества: Позволяет видеть подробный отчёт о каждом успешном тесте.
- Пример использования: `ya test -t -P`

##### Показать пропущенные (отфильтрованные) тесты
- `--show-skipped-tests`:
- Описание: Показать каждый пропущенный (отфильтрованный) тест.
- Преимущества: Позволяет легко увидеть, какие тесты не запускались и по каким причинам.
- Пример использования: `ya test -t --show-skipped-tests`

##### Показать метрики тестов
- `--show-metrics`:
- Описание: Показать метрики тестов.
- Преимущества: Позволяет выводить метрики тестов.
- Пример использования: `ya test -t --show-metrics`

#### Дополнительные флаги и параметры
##### Отладочный режим
- `--test-debug`:
- Описание: Включает режим отладки тестов. При запуске тестов, выведет идентификатор процесса (PID) после запуска и включает дополнительные параметры такие как `--test-threads=1`, `--test-disable-timeout`, `--retest` и `--test-stderr`.
- Преимущества: Помогает проводить отладку тестов, выявлять причины сбоев и получать больше информации для диагностики проблем.
- Пример использования: `ya test -t --test-debug`

##### Запуск исполняемых тестов с дебаггером
- `--pdb`, `--gdb`, `--dlv`:
- Описание: Запуск тестов с интеграцией в различные отладчики (например, `pdb` для `Python`, `gdb` для `C++` или `dlv` для `Go`).
- Преимущества: Позволяет проводить глубокую отладку тестов в выбранных отладчиках, что помогает в  детальной диагностике и устранении ошибок.
- Пример использования: `ya test -t --gdb`

#### Суммирование вывода результатов

В конце выполнения тестов для всех упавших тестов будет выдана краткая информация о падениях (включая ссылки на более полную информацию). Для прошедших и проигнорированных (отфильтрованных) тестов будет выдан только общий короткий статус с количеством тех и других тестов.

Примеры полного отчета при использовании различных опций:
```
ya test -t --show-passed-tests --show-skipped-tests --show-metrics
```
В этом примере выводится информация о всех успешно пройденных тестах, отфильтрованных тестах, а также метрики тестирования, что дает полный обзор выполненных действий и результатов тестирования.

** Пример **
```
# Список всех пользовательских тестов (без тестов стиля, импортов и подобных проверок)
ya test -AL --regular-tests devtools/examples/tutorials/python
```

### Выборочное тестирование

Команда `ya test` поддерживает большое количество опций для фильтрации и выборочного запуска тестов.

#### Фильтрация тестов по имени
- `-F=TESTS_FILTERS`, `--test-filter=TESTS_FILTERS`:
  - Описание: Эта опция позволяет ограничить тестирование только определенными тестами, соответствующими указанным фильтрам. Фильтры могут быть именами тестов, частями имен, или другими идентифицирующими шаблонами.
  - Пример использования: Запуск тестов, имя которых содержит “subname”.
```
    ya test -A -F “subname”
```
  - Символы-шаблоны: В фильтрах можно использовать символы подстановки, такие как `*`, который соответствует любому количеству символов. Каждый последующий фильтр расширяет множество тестов для запуска.
   
#### Фильтрация тестов по тегам
- `--test-tag=TEST_TAGS_FILTER`:
  - Описание: Позволяет запускать только те тесты, которые помечены определенными тегами. Теги— это пользовательские метки, которые могут быть назначены на тесты для группировки по определенным признакам или функциональности.
  - Синтаксис: Перед именами тегов можно использовать + для включения тега в фильтр и - для исключения.
  - Пример: 
```
      ya test -A --test-tag tag1+tag2-tag3
```
    Эта команда запустит все тесты, у которых есть теги tag1 и tag2 и нет тега tag3.

#### Фильтрация тестов по размеру
- `--test-size=TEST_SIZE_FILTERS`:
  - Описание: Фильтр для запуска тестов определенного размера (SMALL, MEDIUM, LARGE), позволяющий более точно настроить объем запускаемых тестов в зависимости от текущих потребностей.
  - Пример использования:
```
    ya test -A --test-size=MEDIUM
```
    Эта команда запустит только тесты среднего размера (MEDIUM).

#### Фильтрация тестов по типу
- `--test-type=TEST_TYPE_FILTERS`:
  - Описание: Ограничивает запуск только теми тестами, которые относятся к указанным типам (например, UNITTEST, PYTEST). 
  - Синтаксис: Перед именами типов тестов можно использовать `+` для включения и `-` для исключения.
  - Пример:
    ```
      ya test -tt --test-type unittest+gtest
    ```
    Эта команда запустит только тесты типов unittest и gtest.
    ```
    ya test -tt --test-type -import_test
    ```
    Эта команда запустит все тесты, кроме `import_test`.

#### Фильтрация тестов по имени файлов
- `--test-filename=TEST_FILES_FILTER`:
  - Описание: Эта опция позволяет запускать тесты только из выбранного исходного файла. Работает только для pytest и hermione, другие тестовые фреймворки не предоставляют такой информации.
  - Пример использования:
    ```
    ya test -A --test-filename=test_example.py
    ```
#### Запуск последних упавших тестов
- -X, --last-failed-tests:
  - Описание: Запустить только тесты, упавшие в предыдущем запуске.
  - Преимущества: Эта опция позволяет быстро проверить, были ли исправлены проблемы, обнаруженные в предыдущем прогоне тестов.
  - Пример использования:
    ```
    ya test -t -X
    ```
  - Совместимость с другими фильтрами: Указание дополнительных фильтров (например, с помощью -F) расширяет множество тестов, которые будут запущены. Это может быть полезно, если необходимо следить за корректным статусом некоторых тестов, наряду с перезапуском упавших в предыдущем прогона.



## Параллельный запуск тестов { #fork }

По умолчанию тесты внутри одной suite выполняются последовательно в рамках одного chunk (так называемого sole chunk) в виде отдельного узла графа команд `ya`.
Тесты из разных suite (ya.make) выполняются параллельно, но последовательно в рамках одно chunk.

Во время формирования графа команда `ya` не может знать, сколько будет тестов в suite, так как для этого требуется сборка и листинг тестов средствами тестового фреймворка.
Так как `ya` оперирует статическим графом команд (он не меняется по мере исполнения и целиком известен для исполнителя), то на этапе конфигурации мы только можем заранее вставить нужное количество chunk'ов, каждый из которых исполнит непересекающееся множество тестов.

Чтобы разбить выполнение тестов из suite на несколько chunk'ов, нужно воспользоваться макросами `FORK_TESTS`, `FORK_SUBTESTS` и `FORK_TEST_FILES`.

Каждый chunk наследует общие параметры теста из `ya.make`: размер, таймаут, требования на ресурсы и другие: таким образом удобно распараллелить тесты, которые из-за своего количества перестали укладываться в таймаут.

* `FORK_TESTS`, `FORK_SUBTESTS` – режимы, при которых вместо sole chunk запуск suite разбивается на несколько chunk'ов, каждый из которых получает дополнительные параметры в виде общего количества chunk'ов, участвующих в разбиении и своего порядкового номера: по этим параметрам каждый chunk определяет подмножество тестов, которое надо запустить.
Количество chunk'ов по умолчанию равно `10`, это значение можно изменить с помощью `SPLIT_FACTOR(X)` (при локальной разработке `SPLIT_FACTOR` можно переопределить с помощью `--split-factor=Х`. `--split-factor=1` отключает режим форков).
Отличие `FORK_TESTS` от `FORK_SUBTESTS` заключается в том, что `FORK_TESTS` считает тесты, объединенные в классы, неделимой сущностью, в то время как `FORK_SUBTESTS` разбивает в том числе тестовые классы и в разных chunk'ах могут оказаться тесты, принадлежащие одному классу, что может быть нежелательно, если у классов есть тяжёлые подготовительные стадии.

* `FORK_TEST_FILES` – разбивает прогон тестов из suite на количество chunk'ов, равное количеству файлов с тестами, перечисленных в `ya.make`, каждый запуск работает только с одним конкретным файлом.

`FORK_TESTS`, `FORK_SUBTESTS` принимают необязательный аргумент - `SEQUENTIAL` или `MODULO`, определяющий, как будет происходить разделение тестов по chunk'ам.
`SEQUENTIAL` разделяет тесты равными диапазонами, предварительно их отсортировав по имени.
`MODULO` разделяет тесты по модулю `SPLIT_FACTOR`,  предварительно их отсортировав (т.е. при `SPLIT_FACTOR(2)`, первый тест попадёт в первый chunk, второй тест во второй, третий в первый и т.д.)
Если аргумент не указан, значение по умолчанию - `SEQUENTIAL`.

`FORK_TEST_FILES` можно комбинировать с `FORK_TESTS` или `FORK_SUBTESTS`, тогда будет дополнительное разбиение запуска тестов из каждого файла.

`FORK_TEST_FILES` поддержан только для `pytest`.






## Фильтрация тестов { #test_filtering }

Suite можно фильтровать по различным свойствам:

- `--test-size=TEST_SIZE_FILTERS` — запускать только выбранные размеры
- `--test-type=TEST_TYPE_FILTERS` — запускать только выбранные [типы тестов](#test_type). Перед именами типов тестов можно использовать `+` для включения suite в фильтр и `-` для исключения. Таким образом `--test-type -import_test` запустит все тесты, кроме `import_test`. Фильтр `--test-type unittest+gtest` запустит только `unittest` и `gtest`.
- `--style` — запускать только тесты стиля
- `--regular-tests` — запускать только пользовательские тесты
- `--test-tag=TEST_TAGS_FILTER` — запускать только сюиты с определёнными тегами. Перед именами тегов можно использовать `+` для включения тега в фильтр и `-` для исключения. Таким образом `--test-tag tag1+tag2-tag3` запустит все тесты, у которых есть `tag1`, `tag2` и нет `tag3`. Фильтр `--test-tag -tag3` запустит все тесты без тега `tag3`. Фильтр `--test-tag ya:anytag` запустит все тесты со всеми тегами.

Помимо фильтрации suite можно фильтровать отдельные тесты:

-  `-F=TESTS_FILTERS`, `--test-filter=TESTS_FILTERS` — фильтрация тестов по имени. Будет запущен тест, полное имя которого строго соответствует `TESTS_FILTERS`. Для запуска подмножества тестов в шаблоне можно указать символ `*` (соответствует любому количеству символов). Каждый последующий шаблон расширяет подмножество запускаемых тестов. Например `-F '*a' -F 'B*c'` запустит все тесты имена которых заканчиваются на `a` или начинаются на `B` и заканчиваются на `c`. Шаблоны взяты в одинарные кавычки для того чтобы shell не развернул фильтр в список файлов, которому может соответствовать шаблон.
-  `-F="[X/Y] chunk"`, `--test-filter="[X/Y] chunk"` — фильтрация тестов по chunk'ам. Внутри `[]` можно использовать `*` для фильтрации.
- `--test-filename=TEST_FILES_FILTER` — запускать тесты только из выбранного исходного файла (работает только для `pytest` и `hermione`, другие тестовые фреймоврки не предоставляют такой информации).
- `-X`, `--last-failed-tests` — запустить только тесты упавшие в предыдущем запуске. Указание дополнительных фильтров (например с помощью `-F`) расширяет множество тестов, которое будет запущено. Обычно это требуется, когда вы хотите следить за корректным статусом некоторых тестов, помимо перезапуска упавших от предыдущего прогона.

При указании флага `-F` можно использовать [специальные символы](https://docs.python.org/3/library/fnmatch.html):

```bash
$ ya make -t -F <file>.py::<ClassName>::*
```

JUnit5-тесты можно фильтровать по тегам `@Tag`:

- `--junit-args '--junit-tags "tag1 tag2 tag3"'` - запуск всех тестов, у которых есть хотя бы один из указанных тегов (теги можно также разделять плюсом, например `tag1+tag2`). Подробнее можно почитать [тут](../../manual/tests/java.md#filtering).

## Канонизация (и переканонизация)

Система сборки ya make для некоторых типов тестов поддерживает сравнение с эталонными (каноническими) данными. Если эти данные нужно обновить воспользуйтесь опцией `-Z` (`--canonize-tests`).
В этом режиме вместо сравнения данных с эталонными, сами эталонные данные будут заменены и при необходимости отправлены в Sandbox. В локальное рабочее пространство будут внесены все необходимые изменения.

## Типы тестов { #test_type }

**Типом теста** называется выполнение проверок с использованием одного конкретного инструмента, например, фреймворка `pytest` для Python или утилиты проверки форматирования кода `go fmt` для Golang. Полный список типов тестов приведен в таблице:

Тип | Описание
:--- | :---
`black` | Проверка форматирования кода на python3 утилитой [black](../../manual/tests/style#black).
`classpath.clash` | Проверка наличия дублирующихся классов в classpath при компиляции Java проекта.
`eslint` | Проверка стиля и типичных ошибок кода на TypeScript с использованием утилиты [ESLint](https://eslint.org/).
`exectest` | Выполнение произвольной команды и проверка её кода возврата
`flake8.py2` | Проверка стиля кода на Python 2 c использованием утилиты [Flake8](https://gitlab.com/pycqa/flake8)
`flake8.py3` | Проверка стиля кода на Python 3 c использованием утилиты [Flake8](https://gitlab.com/pycqa/flake8)
`fuzz` | [Fuzzing](https://en.wikipedia.org/wiki/Fuzzing) тест
`g_benchmark` | Выполнение бенчмарков на C++ библиотекой [Google Benchmark](https://github.com/google/benchmark)
`go_bench` | Выполнение бенчмарков на Go утилитой `go bench`
`gofmt` | Проверка форматирования кода на Go утилитой `go fmt`
`go_test` | Выполнение тестов на Go утилитой `go test`
`govet` | Выполнение статического анализатора кода на Go утилитой `go vet`
`gtest` | Выполнение тестов на С++ с использованием фреймворка [Google Test](https://github.com/google/googletest/)
`java` | Выполнение тестов на Java с использованием фреймворка [JUnit](https://junit.org/)
`java.style` | Проверка форматирования кода на Java утилитой [checkstyle](https://checkstyle.org/)
`ktlint` | Проверка стиля Kotlin кода с использованием утилиты [ktlint](https://ktlint.github.io)
`py2test` | Тесты на Python 2 с использованием фреймворка [pytest](https://pytest.org/)
`py3test` | Тесты на Python 3 с использованием фреймворка [pytest](https://pytest.org/)
`pytest` | Тесты на Python любой версии с использованием фреймворка [pytest](https://pytest.org/)
`unittest`| Тесты на C++ с использованием фреймворка 

