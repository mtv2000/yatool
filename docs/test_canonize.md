## Канонизация тестов

Канонизация — это процесс определения и фиксации эталонных (канонических) данных для тестов, которые впоследствии будут использоваться для сравнения с текущими результатами тестов. Это позволяет убедиться, что результаты выполнения тестов остаются стабильными и совпадают с ожидаемыми результатами, тем самым обеспечивает сохранение качества и корректности программного обеспечения.

Процесс канонизации включает следующие шаги:

1. Первичный запуск и сохранение данных:
- Первичная канонизация: При первом запуске теста его результаты сохраняются в качестве эталонных данных (канонических данных). Эти данные будут использоваться для всех последующих сравнений.
- Фиксация канонических данных: Эти результаты фиксируются и сохраняются в определенном формате и расположении, чтобы они могли быть легко доступны для последующих сравнений. Обычно они сохраняются в директорию `canondata/<test name>/result.json`.

2. Сравнение с эталонными данными:
- Регулярные запуски тестов: При каждом новом запуске тестов результаты текущего выполнения сравниваются с эталонными данными, сохраненными в ходе первичной канонизации.
- Обработка отклонений: Если результаты текущего теста отклоняются от эталонных данных, система сигнализирует об этом и предоставляет отчет о различиях.

3. Актуализация канонических данных:
- Обновление эталонов: При изменении в коде или данных, эталонные результаты могут быть обновлены для отражения новых изменений. Этот процесс называется переканонизацией.

### Основные компоненты системы канонизации

- Фреймворки тестирования: Поддержка канонизации предоставляется большинством фреймворков тестирования для различных языков программирования. Каждый фреймворк для написания тестов предоставляет свою поддержку механизма канонизации, описанную в соответствующих разделах.
- Хранение данных: Канонические данные управляются системой и хранятся в определенных директориях.
- Инструменты сравнения: Для проверки соответствия результатов тестов используются стандартные и кастомные инструменты сравнения (diff tools).

### Ограничения и особенности

- Поддержка языков: Канонизация поддерживается для множества языков программирования, за исключением C++, для которого не предусмотрена нативная канонизация (предоставлены альтернативные способы).
- Хранение данных: Не рекомендуется вручную изменять данные внутри директории canondata. Все изменения должны выполняться через систему канонизации.
- Для тестов на стороне `ya` канонические данные находятся в доступе при помощи команды `ya make`.

### Как включить канонизацию

Для включения канонизации тестов используется опция `-Z` или `--canonize-tests`. В этом режиме вместо сравнения результатов теста с эталонными данными, система сохранит текущие результаты как новые эталонные данные.
```
  ya make -tF <test name> --canonize-tests --local
```
Если необходимо обновить эталонные данные (например, изменён тест или его логика), запуск с опцией `-Z` сохранит новые эталонные данные вместо старых. 
```
ya make -AZ  --local
```
Не изменяйте канонические данные вручную. Это может привести к некорректному функционированию тестов, так как система сравнивает контрольные суммы файлов, и любые ручные изменения не будут учтены.

Иногда при переканонизации могут возникать ошибки (например, проблемы с кэшем). В таких случаях необходимо очищать кэш и повторно запускать тест.
```
ya gc cache --size-limit 0
```
### Просмотр ретроспективы канонического результата теста

Ретроспектива канонического результата теста позволяет отслеживать изменения канонических данных во времени. Это полезно для анализа, как и почему изменялись результаты тестов, а также для отладки проблем, связанных с канонизацией. 

Для просмотра ретроспективы канонического результата теста, нужно использовать режим `--canon-diff`. Запуск команды осуществляется через `ya make` с указанием соответствующих параметров:
```
ya make -t --canon-diff PREV
```
#### Аргументы для режима --canon-diff

- PREV: Сравнивает канонические данные теста с предыдущей ревизией.
- HEAD: Смотрит на текущую ревизию кода.
- <rev1>:<rev2>: Сравнивает канонические данные между двумя указанными ревизиями, где <rev1> и <rev2> — это идентификаторы ревизий.

Можно передать имя теста через параметр -F(--test-filter), для этого можно сначала вывести список тестов в текущей папке.
```
project/ya make -t --canon-diff HEAD -L
```

### Скачивание канонических данных из разных хранилищ

Чтобы результаты канонизации могли быть переиспользованы разными backend-ами, при канонизации тестов можно указать параметр `--canonization-backend`. Это значит, что ссылки на ресурсы будут шаблонизированы и смогут резолвиться в разные backend-ы в зависимости от условий запуска тестов.

#### Параметризация backend

При запуске тестов с использованием канонических данных, можно задать свой собственный backend. Это делает систему гибкой и адаптивной к разным условиям запуска.

**Пример команды для запуска тестов с указанием кастомного backend:**
```
ya make -tF <test name> -Z --canonization-backend="<my.custom.backend>"
```

#### Параметризация протокола

Помимо указания кастомного backend-а, вы также можете выбрать протокол для скачивания канонических данных. По умолчанию используется `https`, но это может быть изменено с помощью опции `--canonization-scheme`.
```
ya make -tF <test name> -Z --canonization-backend="<my.custom.backend>" --canonization-scheme="http"
```

### Формат результата канонизации

Результаты канонизации сохраняются в формате JSON и могут включать ссылки на файлы. 

После выполнения канонизации рядом с тестом создается файл `canondata/result.json`, содержащий ссылки на расположение загруженных канонических данных. При использовании параметра `--canonization-backend`, ссылки будут содержать шаблон для подстановки нужного backend’а вместо его явного указания.

**Пример**
```
"uri": "https://{canondata_backend}/1809005/61174eb05585f2f1c67e0387c436e184f0ccc131/resource.tar.gz#exectest.run_hello_world0_/stdout.out"
```

Рассмотри подробнее формат uri:
- схема - https
- бэкенд - {canondata_backend}
- путь до архива  - 1809005/61174eb05585f2f1c67e0387c436e184f0ccc131/resource.tar.gz
- путь до файла внутри архива - exectest.run_hello_world0_/stdout.out


