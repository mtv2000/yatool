## Тесты : общие макросы

### Зависимости

#### DEPENDS() 

```
DEPENDS(path1 [path2...])
```

Указывает зависимости на другие проекты, которые нужно собрать и результаты которых должны быть доступны тесту.


### Параметры suite 

#### SIZE() 

```
SIZE(SMALL | MEDIUM | LARGE)
```

Задаёт размер suite. Сейчас существует три размера:

* **SMALL** - максимальный таймаут *60s*. Размер по умолчанию.
* **MEDIUM** - максимальный таймаут *600s*.
* **LARGE** - максимальный таймаут *3600s*.

Если в ya.make листе указаны несколько значений макроса SIZE(), например, через вложенный INCLUDE, то последнее значение переопределяет все предыдущие.

#### TIMEOUT() 

```
TIMEOUT(time)
```

Устанавливает таймаут на запуск всей сьюиты. По умолчанию равен:
* *60s (1min)* для **SMALL** тестов;
* *600s (10min)* для **MEDIUM** тестов;
* *3600s (1hour)* для **LARGE** тестов.

{% note info %}

Таймаут не может быть больше, чем максимальная длительность теста данного размера.

Если запуск сьюиты разбит на части ([`FORK_TEST_FILES()`](#fork_test_files)/[`FORK_TESTS()`](#fork_tests)/[`FORK_SUBTESTS()`](#fork_subtests)), то указанный таймаут ограничивает время работы каждого запуска в отдельности.

{% endnote %}


### TAG() { #tag }

```
TAG(tag1 [tag2...])
```

Позволяет задать пользовательские теги, по которым можно фильтровать запуск suite в `ya test`, см. опцию [--test-tag](https://docs.yandex-team.ru/ya-make/usage/ya_make/tests#test_filtering).

Ниже представлен список специальных системных тегов, которые могут менять поведение тестов.

#### Запуск тестов: { #test-run }
* `ya:always_minimize`: приводит к постоянной минимизации корпуса после фаззинга, см подробности в документации к [fuzzing](https://docs.yandex-team.ru/ya-make/manual/tests/fuzzing).
* `ya:manual`: тест не будет запускаться, если явно не указано запускать тесты с таким тегом
* `ya:norestart`: тест не будет перезапускаться при определенных ошибках
* `ya:not_autocheck`: не запускать тест при проверке pull requests

##### Логирование: { #logging-tags }
* `ya:full_logs`: приводит к падению сьюиты, если размер логов привысил **100Мб**
* `ya:huge_logs`: увеличивает ограничение на размер логов теста с **100Мб** до **1Гб**
* `ya:sys_info`: добавляет вывод системной информации в лог до и после выполнения всех рецептов и тестов
* `ya:trace_output`: включает логирование создаваемых файлов и их размеров при помощи системного вызова [ptrace](https://en.wikipedia.org/wiki/Ptrace). Работает только под Linux. Может замедлять тестирование
* `ya:dump_node_env`: печатает дерево директорий относительно build_root узла сразу после его запуска в лог `test-results/<suite>/run_test.log`. Позволяет узнать чистое окружение тестового узла, которое приехало по зависимостям
* `ya:dump_test_env`: печатает дерево директорий относительно build_root узла непосредственно перед запуском враппера тестов в лог `test-results/<suite>/run_test.log`. Позволяет узнать окружение в котором будут запускаться тесты (после запуска рецептов). Не работает вместе с `ya:dirty`, так как привело бы к полному обходу arcadia.

##### large-тесты: { #large-tags }
* `ya:fat`: помечает тест как `LARGE`
* `ya:force_distbuild`: запускает тест в distbuild вне зависимости от его размера
* `ya:force_sandbox`: запускает тест в Sandbox. Используется только вместе с тегом `ya:fat`
* `ya:noretries`: тесты с таким тегом не будут запускаться в автосборке повторно
* `ya:privileged`: запускает тесты в [Sandbox](https://docs.yandex-team.ru/sandbox/dev/requirements#privileged) в контейнере от имени root
* `ya:sandbox_coverage`: включает `LARGE` тесты в подсчет [покрытия](https://docs.yandex-team.ru/devtools/test/coverage). Нужно использовать вместе с `ya:force_sandbox`
* `ya:relwithdebinfo`: тесты с таким тэгом будут собираться с флагом `--build relwithdebinfo` - релизная сборка с включенными ассертами для `C++`. Тесты, собранные с `--build relwithdebinfo`, могут исполняться медленне, чем для релизной сборки, но ассерты могут дать больше полезной информации.

##### Управление окружением: { #environment-tags }
* `ya:copydata`: Пути, указанные в макросе `DATA()` подключаются в тестовое окружение не симлинками, а рекурсивно копируются, при этом всем файлам и каталогам выставляются права на запись пользователя и группы
* `ya:copydataro`: Аналогично `ya:copydata`, но наоборот, всем файлам и каталогам запрещается запись для пользователя, группы и других

##### Остальные: { #specific-tags }
* `ya:external`: уведомляет систему, что тест использует внешние системы (сеть, внешние базы данных). Это значит, что такой тест потенциально нестабильный. Уведомления о поломках таких тестов будут приходить только владельцам теста и не будут приходить авторам комита, на котором тест сломался
* `ya:no_graceful_shutdown`: завершает выполнение процесса с тестами при помощи сигнала `SIGQUIT` вместо `SIGTERM`. Это позволяет, например, поймать стектрейс состояния, в котором находится тест
* `ya:notags`: используется для фильтрации тестов, не имеющих тегов

##### Sandbox-теги: { #sandbox-tags }
* `sb:XXXX`: позволяет задать набор [тегов](https://docs.yandex-team.ru/sandbox/agents#tags) для выбора агента [Sandbox](https://sandbox.yandex-team.ru/home). При указании нескольких тегов `sb:`, они соединяются через логическое `ИЛИ`
* `sb:ttl=inf`: позволяет задать `TTL` в днях для создаваемого в таске `YA_MAKE` ресурса `BUILD_OUTPUT`. Тег следует использовать, если автозапуск `LARGE` тестов от лица вашего робота потребляет много дисковой квоты из-за больших выходных данных в этом ресурсе. `TTL` по умолчанию равен **14 дней**
* `sb:logs_ttl=14`: позволяет задать `TTL` в днях для создаваемого в таске `YA_MAKE` ресурса `TASK_LOGS`. Тег следует использовать, если автозапуск `LARGE` тестов от лица вашего робота потребляет много дисковой квоты из-за больших выходных данных в этом ресурсе. `TTL` по умолчанию равен **14 дней**
* `sb:store_output_binaries`: сохраняет собранные бинари large-тестов в ресурсах типа `BUILD_OUTPUT` таски `YA_MAKE`

### REQUIREMENTS() { #requirements }

```
REQUIREMENTS(
    [cpu:<count>]
    [disk_usage:<size>]
    [ram:<size>]
    [ram_disk:<size>]
    [container:<id>]
    [network:<restricted|full>]
    [dns:<default|local|dns64>])
    [yav:<ENV_NAME>=<value|file>:<owner>:<vault key>]
)
```

Позволяет настроить требования к окружению, в котором будет выполняться тест.
Large-тесты в основном запускаются под Sandbox, поэтому всё, что связано с Sandbox, можно смело соотносить с Large-тестами (кроме случаев когда large-тесты запускаются на YT).

| Name | Default | Values | Applicability | Description |
|:-----------:|:---------:|:---------:|:---------:|:---------|
| container | - | `<sbr-res-id>` | Sandbox | ID Sandbox контейнера, в котором будет выполняться тест |
| cpu | 1 | `1..` / `all` | Local / Distbuild / Sandbox | Количество процессорных ядер, необходимых тестам для корректной работы. Конечное значение рассчитывается как `min(требуемое, количество_ядер_на_хосте)`. При указании `all` тестовый узел будет работать монопольно, в этом случае если у suite есть [несколько chunk](https://docs.yandex-team.ru/ya-make/usage/ya_make/tests#fork), то запуск выстроится в цепочку запуска chunk. <br/> Distbuild может выдавать тестам [не больше 4-х cpu](https://docs.yandex-team.ru/distbuild/limits#compute) и часто выдаёт фактически CPU меньше заказанного из-за [использования stat модели](https://docs.yandex-team.ru/distbuild/nodes_resources#motivation) - в случае fail-а test-а он будет перезапущен с выдачей полных требований (т.е. distbuild возвращает результаты для упавших тестов только для запусков с полными гарантиями по cpu), но время выполнения успешно завершившихся тестов может сильно варьироваться из-за этого уплотнения. |
| disk_usage | 100  | `1..`  | Sandbox | Необходимый объём свободного места на файловой системе в *Gb*. Для Large теста превращается в требование disk_usage у Sandbox таски. |
| dns | `default`  | `default` / `local` / `dns64` | Sandbox | Настраивает использование [NAT64](https://en.wikipedia.org/wiki/NAT64) в [Sandbox](https://docs.yandex-team.ru/sandbox/dev/requirements#dns). </br>`default` - доступ в интернет по IPv4 невозможен, </br>`local` - используются настройки из файла `/etc/resolv.conf.local`. Имеет смысл только для кастомных контейнеров, в которых этот файл существует. </br>`dns64` - доступ в Интернет по IPv4 возможен. Весь резолвинг имён происходит через ферму `ns64-cache.yandex.net` |
| network | `restricted` | `restricted` / `full` | Local* / Distbuild | Определяет тип доступа к сети. </br>`full` - есть доступ во внешнюю сеть. </br>`restricted` - можно использовать только `localhost`. </br>Локально учитывается только на linux при указании ключа `--private-ns-drive` (или `--autocheck-mode`). |
| ram | - | `1..`  | Distbuild / Sandbox | Необходимый объём оперативной памяти в *Gb*. |
| ram_disk | - | `1..`  | Local* / Sandbox / Distbuild | Необходимый объём RAM диска в *Gb*. </br>На Distbuild выделяется для каждого узла. </br>На Sandbox выдяляется один на всю suite - заказывается в виде требования у Sandbox таски. </br>Локально учитывается только на linux при указании ключа `--private-ram-drive` (или `--autocheck-mode`). Тест может узнать путь к созданому для него RAM диску через API взаимодействия с тестовым окружением: [Java](https://docs.yandex-team.ru/ya-make/manual/tests/java#direktorii-dostupnye-testu), [Python](https://docs.yandex-team.ru/ya-make/manual/tests/python#yatest) |
| yav | - | см. описание | Sandbox | Ключ из [секретницы](https://yav.yandex-team.ru/) в виде шаблона `<ENV_NAME>=<value/file>:<sec-id>:<key>`, который получит тест через указанную переменную окружения, где </br>`<ENV_NAME>` - имя переменной, </br>`<value/file>` тип передачи секрета (`value` - значение секрета будет записано в указанный `ENV_NAME`, `file` - секрет будет записан во временный файл и до путь до него будет передан через `ENV_NAME`), </br>`<sec-id>` - id yav секрета, </br>`<key>` - имя ключа из секрета </br></br>Мы крайне не рекомендуем использовать секреты и предлагаем стараться обходиться без них, используя моки или другие техники тестирования. </br>Использование секрета ломает воспроизводимость теста и не позволяет его запускать разработчикам без доступа до него. Так же появляется стейт за границами репозитория и статуc теста начинает зависеть от комплементарности системы использующей секрет и самого секрета в yav.</br></br> При использовании секретов suite автоматически получает тег `ya:external`, т.е. падения такого тестa в CI будут видны только владельцам теста.|
| sb_vault | - | см. описание | Sandbox | **Deprecated, используйте yav** .</br></br> Ключ из [sandbox-vault](https://sandbox.yandex-team.ru/admin/vault). Должен соответствовать паттерну `<ENV_NAME>=<value/file>:<owner>:<vault key>`. </br></br> Для доступа из Large-тестов секрет должен быть пошарен (`Shared with`) с группой `REVIEW-CHECK-FAT`. </br></br> При использовании секретов suite автоматически получает тег `ya:external`, т.е. падения такого тестa в CI будут видны только владельцам теста. |

{% note info %}

1. Параметры `disk_usage` и `container` работают только для `LARGE` тестов.
2. Параметр `container` позволяет запускать тесты в заранее подготовленном окружении в виде образа LXC или Porto контейнера.
3. Поскольку RAM-диск использует оперативную память, суммарное значение полей `ram` и `ram_disk` не может превышать максимально возможное значение размера оперативной памяти для тестов данного размера.

{% endnote %}

Актуальные требования можно посмотреть [вот тут](https://a.yandex-team.ru/arc/trunk/arcadia/devtools/ya/test/const/__init__.py#L230), словарь `TestSize.DefaultRequirements`.

| Requirement | SMALL     | MEDIUM    | LARGE     |
|:-----------:|:---------:|:---------:|:---------:|
| CPU         | `1 .. 4`  | `1 .. 4`  | `1 .. 4`  |
| RAM         | `8 .. 32` | `8 .. 32` | `8 .. 32` |
| RAM disk    | `0 .. 4`  | `0 .. 4`  | `0 .. 4`  |

Требования для LARGE учитываются только при запуске на Distbuild - для тестов размеченных с помощью тега `TAG(ya:force_distbuild)`.
По умолчанию LARGE тесты сейчас запускаются в Sandbox, где нет этих ограничений.


### ENV() { #envs }

```
ENV(key=[value])
```

Задает значение переменной окружения `key` значение `value` при запуске теста.


## Параллельный запуск тестов { #parallel }

### FORK_TESTS() { #fork_tests }

```
FORK_TESTS(mode)
```

Разбивает запуск suite на несколько chunk'ов. По умолчанию количество chunk'ов равно 10. Это значение можно изменить с помощью макроса [`SPLIT_FACTOR(x)`](#split_factor). В отличие от [`FORK_SUBTESTS`](#fork_subtests) считает тесты, объединенные в один класс, неделимой сущностью.

Каждый chunk наследует общие параметры теста из `ya.make`: размер, таймаут, требования на ресурсы. Поэтому этот макрос удобно использовать, чтобы распараллелить тесты, которые не укладываются в таймаут.

Параметр `mode` определяет, каким образом будет происходить распределение тестов по chunk'ам. Может быть равен `SEQUENTIAL` или `MODULO`. Если аргумент не указан, то по умолчанию равен `SEQUENTIAL`. `SEQUENTIAL` распределяет тесты равными диапозонами, предварительно отсортировав их по имени. `MODULO` разделяет тесты по модулю, предварительно их отсортировав.


### FORK_SUBTESTS() { #fork_subtests }

```
FORK_SUBTESTS(mode)
```

Разбивает запуск suite на несколько chunk'ов. По умолчанию количество chunk'ов равно 10. Это значение можно изменить с помощью макроса [`SPLIT_FACTOR(x)`](#split_factor). В отличие от [`FORK_TESTS`](#fork_tests) может разбивать тесты, объединенные в один класс, в разные chunk'и. Нежелательно использовать, если у классов есть тяжелые подготовительные стадии.

Каждый chunk наследует общие параметры теста из `ya.make`: размер, таймаут, требования на ресурсы. Поэтому этот макрос удобно использовать, чтобы распараллелить тесты, которые не укладываютсмя в таймаут.

Параметр `mode` определяет, каким образом будет происходить распределение тестов по chunk'ам. Может быть равен `SEQUENTIAL` или `MODULO`. Если аргумент не указан, то по умолчанию равен `SEQUENTIAL`. `SEQUENTIAL` распределяет тесты равными диапозонами, предварительно отсортировав их по имени. `MODULO` разделяет тесты по модулю, предварительно их отсортировав.


### FORK_TEST_FILES() { #fork_test_files }

```
FORK_TEST_FILES()
```

Разбивает прогон тестов из suite на количество chunk'ов, равное количеству файлов с тестами, перечисленных в `ya.make`. Каждый запуск работает только с одним конкретным файлом.

Можно комбинировать вместе с [`FORK_TESTS()`](#fork_tests) и [`FORK_SUBTESTS()`](#fork_subtests). В этом режиме будет происходить дополнительное разбиение тестов для каждого файла.

{% note warning %}

Поддержан только для pytest.

{% endnote %}


### SPLIT_FACTOR() { #split_factor }

```
SPLIT_FACTOR(x)
```

Изменяет количество chunk'ов при параллельном запуске тестов. Можно использовать только с [`FORK_TESTS()`](#fork_tests) и [`FORK_SUBTESTS()`](#fork_subtests).


## Специфичные макросы { #specific }

### USE_RECIPE() { #recipe }

```
USE_RECIPE(path [arg1 arg2...])
```

Подключает рецепт для настройки тестового окружения к тесту. Если тест описан с использованием макросов `FORK_TEST() / FORK_SUBTESTS()`, то рецепт будет подготавливать отдельное окружение для каждого запуска.

[Здесь](recipe) можно прочитать про то, как настраивать тестовое окружение с помощью рецептов.


### SKIP_TEST() { #skip_test }

```
SKIP_TEST(Reason)
```

Отключает тесты для всей модульной сьюиты. Параметром указывается причина отключения.


### NO_LINT() { #no_lint }

```
NO_LINT()
```

Отключает codestyle проверки для java и python.

{% note warning %}

Использование `NO_LINT()` разрешено только в `contrib`.

{% endnote %}
