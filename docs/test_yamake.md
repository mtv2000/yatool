## Тесты : общие макросы

### Зависимости

#### DEPENDS() 

```
DEPENDS(path1 [path2...])
```

Указывает зависимости на другие проекты, которые нужно собрать и результаты которых должны быть доступны тесту.

### Параметры suite 

#### SIZE() 

```
SIZE(SMALL | MEDIUM | LARGE)
```

Задаёт размер suite. Сейчас существует три размера:

* **SMALL** - максимальный таймаут *60s*. Размер по умолчанию.
* **MEDIUM** - максимальный таймаут *600s*.
* **LARGE** - максимальный таймаут *3600s*.

Если в ya.make листе указаны несколько значений макроса SIZE(), например, через вложенный INCLUDE, то последнее значение переопределяет все предыдущие.

#### TIMEOUT() 

```
TIMEOUT(time)
```

Устанавливает таймаут на запуск всей сьюиты. По умолчанию равен:
* *60s (1min)* для **SMALL** тестов;
* *600s (10min)* для **MEDIUM** тестов;
* *3600s (1hour)* для **LARGE** тестов.

Таймаут не может быть больше, чем максимальная длительность теста данного размера.

Если запуск сьюиты разбит на части ([`FORK_TEST_FILES()`](#fork_test_files)/[`FORK_TESTS()`](#fork_tests)/[`FORK_SUBTESTS()`](#fork_subtests)), то указанный таймаут ограничивает время работы каждого запуска в отдельности.

#### TAG()

```
TAG(tag1 [tag2...])
```

Позволяет задать пользовательские теги, по которым можно фильтровать запуск suite в `ya test`, c опцией `--test-tag`.

Ниже представлен список специальных системных тегов, которые могут менять поведение тестов.

#### Запуск тестов:
* `ya:always_minimize`: приводит к постоянной минимизации корпуса после фаззинга.
* `ya:manual`: тест не будет запускаться, если явно не указано запускать тесты с таким тегом.
* `ya:norestart`: тест не будет перезапускаться при определенных ошибках.
* `ya:not_autocheck`: не запускать тест при проверке `pull requests`.

##### Логирование: 
* `ya:full_logs`: приводит к падению сьюиты, если размер логов привысил **100Мб**
* `ya:huge_logs`: увеличивает ограничение на размер логов теста с **100Мб** до **1Гб**
* `ya:sys_info`: добавляет вывод системной информации в лог до и после выполнения всех рецептов и тестов
* `ya:trace_output`: включает логирование создаваемых файлов и их размеров при помощи системного вызова [ptrace](https://en.wikipedia.org/wiki/Ptrace). Работает только под Linux. Может замедлять тестирование
* `ya:dump_node_env`: печатает дерево директорий относительно build_root узла сразу после его запуска в лог `test-results/<suite>/run_test.log`. Позволяет узнать чистое окружение тестового узла, которое собрано по зависимостям
* `ya:dump_test_env`: печатает дерево директорий относительно build_root узла непосредственно перед запуском враппера тестов в лог `test-results/<suite>/run_test.log`. Позволяет узнать окружение в котором будут запускаться тесты. Не работает вместе с `ya:dirty`.

##### large-тесты:
* `ya:fat`: помечает тест как `LARGE`
* `ya:relwithdebinfo`: тесты с таким тэгом будут собираться с флагом `--build relwithdebinfo` - релизная сборка с включенными ассертами для `C++`. Тесты, собранные с `--build relwithdebinfo`, могут исполняться медленне, чем для релизной сборки, но ассерты могут дать больше полезной информации.

##### Управление окружением:
* `ya:copydata`: Пути, указанные в макросе `DATA()` подключаются в тестовое окружение не симлинками, а рекурсивно копируются, при этом всем файлам и каталогам выставляются права на запись пользователя и группы
* `ya:copydataro`: Аналогично `ya:copydata`, но наоборот, всем файлам и каталогам запрещается запись для пользователя, группы и других

##### Остальные: 
* `ya:external`: уведомляет систему, что тест использует внешние системы (сеть, внешние базы данных). Это значит, что такой тест потенциально нестабильный.
* `ya:no_graceful_shutdown`: завершает выполнение процесса с тестами при помощи сигнала `SIGQUIT` вместо `SIGTERM`. 
* `ya:notags`: используется для фильтрации тестов, не имеющих тегов.

#### REQUIREMENTS() 
```
REQUIREMENTS(
    [cpu:<count>]
    [disk_usage:<size>]
    [ram:<size>]
    [ram_disk:<size>]
    [container:<id>]
    [network:<restricted|full>]
    [dns:<default|local|dns64>])
    [yav:<ENV_NAME>=<value|file>:<owner>:<vault key>]
)
```

Позволяет настроить требования к окружению, в котором будет выполняться тест.

| Name | Default | Values | Applicability | Description |
|:-----------:|:---------:|:---------:|:---------:|:---------|
| cpu | 1 | `1..` / `all` | Local | Количество процессорных ядер, необходимых тестам для корректной работы. Конечное значение рассчитывается как `min(требуемое, количество_ядер_на_хосте)`. При указании `all` тестовый узел будет работать монопольно, в этом случае если у suite есть несколько `chunk`, то запуск выстроится в цепочку запуска chunk.  |
| disk_usage | 100  | `1..`  |  | Необходимый объём свободного места на файловой системе в *Gb*.  |
| network | `restricted` | `restricted` / `full` | Local | Определяет тип доступа к сети. `full` - есть доступ во внешнюю сеть. `restricted` - можно использовать только `localhost`. Локально учитывается только на linux при указании ключа `--private-ns-drive` (или `--autocheck-mode`). |
| ram | - | `1..`  |  | Необходимый объём оперативной памяти в *Gb*. |
| ram_disk | - | `1..`  | Local | Необходимый объём RAM диска в *Gb*. Локально учитывается только на linux при указании ключа `--private-ram-drive` (или `--autocheck-mode`). Тест может узнать путь к созданому для него RAM диску через API взаимодействия с тестовым окружением. |


1. Параметры `disk_usage` и `container` работают только для `LARGE` тестов.
2. Параметр `container` позволяет запускать тесты в заранее подготовленном окружении в виде образа LXC или Porto контейнера.
3. Поскольку RAM-диск использует оперативную память, суммарное значение полей `ram` и `ram_disk` не может превышать максимально возможное значение размера оперативной памяти для тестов данного размера.


Актуальные требования можно посмотреть в таблице:

| Requirement | SMALL     | MEDIUM    | LARGE     |
|:-----------:|:---------:|:---------:|:---------:|
| CPU         | `1 .. 4`  | `1 .. 4`  | `1 .. 4`  |
| RAM         | `8 .. 32` | `8 .. 32` | `8 .. 32` |
| RAM disk    | `0 .. 4`  | `0 .. 4`  | `0 .. 4`  |

#### ENV() 

```
ENV(key=[value])
```

Задает значение переменной окружения `key` значение `value` при запуске теста.


### Параллельный запуск тестов 

#### FORK_TESTS() 

```
FORK_TESTS(mode)
```

Разбивает запуск suite на несколько chunk'ов. По умолчанию количество chunk'ов равно 10. Это значение можно изменить с помощью макроса `SPLIT_FACTOR(x)`. В отличие от `FORK_SUBTESTS` считает тесты, объединенные в один класс, неделимой сущностью.

Каждый chunk наследует общие параметры теста из `ya.make`: размер, таймаут, требования на ресурсы. Поэтому этот макрос удобно использовать, чтобы распараллелить тесты, которые не укладываются в таймаут.

Параметр `mode` определяет, каким образом будет происходить распределение тестов по chunk'ам. Может быть равен `SEQUENTIAL` или `MODULO`. Если аргумент не указан, то по умолчанию равен `SEQUENTIAL`. `SEQUENTIAL` распределяет тесты равными диапозонами, предварительно отсортировав их по имени. `MODULO` разделяет тесты по модулю, предварительно их отсортировав.


#### FORK_SUBTESTS() { #fork_subtests }

```
FORK_SUBTESTS(mode)
```

Разбивает запуск suite на несколько chunk'ов. По умолчанию количество chunk'ов равно 10. Это значение можно изменить с помощью макроса `SPLIT_FACTOR(x)`. В отличие от `FORK_TESTS` может разбивать тесты, объединенные в один класс, в разные chunk'и. 

Нежелательно использовать, если у классов есть тяжелые подготовительные стадии.

Каждый chunk наследует общие параметры теста из `ya.make`: размер, таймаут, требования на ресурсы. Поэтому этот макрос удобно использовать, чтобы распараллелить тесты, которые не укладываютсмя в таймаут.

Параметр `mode` определяет, каким образом будет происходить распределение тестов по chunk'ам. Может быть равен `SEQUENTIAL` или `MODULO`. Если аргумент не указан, то по умолчанию равен `SEQUENTIAL`. `SEQUENTIAL` распределяет тесты равными диапозонами, предварительно отсортировав их по имени. `MODULO` разделяет тесты по модулю, предварительно их отсортировав.

#### FORK_TEST_FILES() 

```
FORK_TEST_FILES()
```

Разбивает прогон тестов из suite на количество chunk'ов, равное количеству файлов с тестами, перечисленных в `ya.make`. Каждый запуск работает только с одним конкретным файлом.

Можно комбинировать вместе с `FORK_TESTS()` и `FORK_SUBTESTS()`. В этом режиме будет происходить дополнительное разбиение тестов для каждого файла.

Поддерживает только `pytest`.

#### SPLIT_FACTOR() 

```
SPLIT_FACTOR(x)
```

Изменяет количество chunk'ов при параллельном запуске тестов. Можно использовать только с `FORK_TESTS()` и `FORK_SUBTESTS()`.

### Специфичные макросы 

#### USE_RECIPE() 
```
USE_RECIPE(path [arg1 arg2...])
```

Подключает рецепт для настройки тестового окружения к тесту. Если тест описан с использованием макросов `FORK_TEST() / FORK_SUBTESTS()`, то рецепт будет подготавливать отдельное окружение для каждого запуска.

### SKIP_TEST() 

```
SKIP_TEST(Reason)
```

Отключает тесты для всей модульной сьюиты. Параметром указывается причина отключения.


### NO_LINT() 
```
NO_LINT()
```

Отключает codestyle проверки для java и python.

Использование `NO_LINT()` разрешено только в `contrib`.
