## Fuzzing

Fuzzing (фаззинг) — это метод тестирования программного обеспечения, при котором в приложение отправляются некорректные, неожиданные или случайные данные. 
Эти данные собираются в так называемый корпус (corpus).

Цель фаззинга — обнаруживать сбои и зависания, выявлять логические ошибки в работе приложения, а также находить утечки памяти.

### Создание FUZZ модуля

Для начала использования фаззинга требуется создать модуль `FUZZ` с реализацией функции `LLVMFuzzerTestOneInput`. 

Для эффективного фаззинга целевая функция должна быть высокопроизводительной и покрывать конкретную функциональность, подлежащую тестированию.

Поддерживается фаззинг на основе `AFL` и `libFuzzer`, однако на данный момент автоматический фаззинг работает только с `libFuzzer`.

### Сборка с libFuzzer

Для сборки `FUZZ` модуля с поддержкой `libFuzzer` необходимо указать санитайзер и параметры покрытия, чтобы fuzzer мог отслеживать, ведет ли ввод к новым исполнениям кода:

```
ya make -A --sanitize=address --sanitize-coverage=trace-div,trace-gep
```
В результате получится исполняемый файл, который и является драйвером фаззинга. 
Тип санитайзера и покрытие можно изменить, подробнее — [в документации LLVM](https://clang.llvm.org/docs/SanitizerCoverage.html).

### Сборка с AFL

Для сборки FUZZ модуля с AFL необходимо запустить сборку с параметром `sanitize-coverage=trace-pc`:
```
ya make --afl --sanitize=undefined --sanitize-coverage=trace-pc%%
```
Для использования AFL требуется внешний драйвер afl-fuzz:
```
ya tool afl-fuzz -i INPUT -o OUTPUT -- /path/to/binary%%
```

### Концепция

Фаззинг разделяется на два процесса:

1. Fuzzing — процесс генерации новых данных для корпуса.
2. Fuzzy Test — проверка существующего корпуса.

#### Fuzzing

Корпус состоит из пользовательских и автоматически сгенерированных данных. 
Пользовательские данные должны храниться в директории `corpus`, рядом с `ya.make`, в виде отдельных файлов (имена не имеют значения). 
Эти примеры составлены вручную и помогают fuzzer в генерации новых сценариев.

Автоматически генерируемые данные c параметром `--fuzz-local-store` сохраняются в `<project_path>/test-results/fuzz/<binname>/mined_corpus.tar`.

Пример локального запуска фаззинга:
```
ya make -r --sanitize=address --sanitize-coverage=trace-div,trace-gep -A --fuzzing
```
#### Fuzzy Tests

Fuzzy тест - это только прогон имеющегося корпуса (пользовательского и автоматического).

Пример локального запуска fuzzy теста:
```
ya make -r --sanitize=address --sanitize-coverage=trace-div,trace-gep -A

```

### Отладка

#### Прогон конкретного кейса

Для прогона конкретного кейса используйте опцию `--fuzz-case`:
```
ya make -r --sanitize=address --sanitize-coverage=trace-div,trace-gep -A --fuzz-case=abs_path
```

#### Ручная минимизация корпуса

Если автоматическая минимизация не успевает выполниться, можно выполнить её вручную:
```
ya make -r --sanitize=address --sanitize-coverage=trace-div,trace-gep -A --fuzzing --fuzz-minimization-only
```
Этого же эффекта можно достичь с помощью ключа `--fuzz-minimize`.

### Метрики

Во время фаззинга `ya make` собирает следующие метрики, доступные при локальном прогоне с параметром `-P --show-metrics` и для теста `fuzz:test`:

- corpus_size — размер текущего корпуса
- fuzz_iterations_per_second — количество итераций в секунду
- number_of_executed_units — общее количество проверенных кейсов
- mined_corpus_size — количество новых кейсов, найденных fuzzer
- peak_rss_mb — пиковое потребление оперативной памяти во время фаззинга
- slowest_unit_time_sec — время выполнения самого медленного кейса

#### Опции по умолчанию

Для фаззинга и прогона fuzzy тестов используются дополнительные параметры:

- -max_total_time=600
- -rss_limit_mb=4096
- -timeout=600


#### FUZZ_OPTS

Опции для фаззинга можно задать с помощью параметра `--fuzz-opts` при запуске `ya make`. 

Например, чтобы изменить время фаззинга:
```
ya make -r --sanitize=address --sanitize-coverage=trace-div,trace-gep --fuzzing -A --fuzz-opts="-max_total_time=300"
```

Для запуска фаззинга с фиксированными параметрами можно использовать макрос `FUZZ_OPTS`:
```
FUZZ_OPTS(
-max_len=1024
-only_ascii=1
-rss_limit_mb=2048
)
```

#### FUZZ_DICTS

Для `libFuzzer` можно указать пути до файлов-словарей относительно корня проекта.
Каждый такой файл содержит строки, каждая из которых представляет отдельный кейс для мутаций и поиска новых данных.

Пример использования макроса:
```
FUZZ_DICTS(
    devtools/test_tool/run_fuzz/tests/data/sample_with_dict/dict.txt
    devtools/test_tool/run_fuzz/tests/data/sample_with_several_dicts/dict.txt
)
```

#### Режим подтверждения покрытия (Fuzz Proof)

Режим подтверждения покрытия `--fuzz-proof X` позволяет установить время `X` в секундах, в течение которого `fuzzer` продолжит работать после последнего найденного кейса. 
Если за это время будет найден новый кейс, фаззинг завершится с ошибкой.

Пример команды запуска фаззинга с доказательством покрытия:
```
ya make -r --sanitize=address --sanitize-coverage=trace-div,trace-gep --fuzzing -A --fuzz-opts="-max_total_time=3600" --fuzz-proof=1800
```

#### Опции фаззинга ya make -t

| Опция | Описание |
|-----------------------|----------|
| --fuzzing | Запускает фаззинг (режим расширения корпуса). |
| --fuzz-opts OPTS | Задаёт опции для libFuzzer.|
| --fuzz-case PATH | Позволяет указать путь до конкретного кейса, который требуется проверить. |
| --fuzz-local-store | Автоматическое сохранение и загрузка расширенного корпуса локально |
| --fuzz-runs X | Позволяет ограничить количество запусков функции. |
| --fuzz-minimize | Всегда минимизировать корпус после фаззинга. |
| --fuzz-minimization-only | Запустить процедуру минимизации корпуса без фаззинга. |
| --fuzz-proof X | Применяет режим подтверждения покрытия. |
